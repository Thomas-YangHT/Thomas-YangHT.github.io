<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="4311"/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;position: relative;"><div><div style="font-family:-apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(26, 26, 26);"><div><div><span><div style="background:rgb(255, 255, 255);"><div style="box-sizing:border-box;overflow:hidden;"><div style="overflow:hidden;width:690px;margin:0px auto;"><h1 style="font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;margin:24px 0px;font-weight:600;font-size:24px;line-height:1.22;word-wrap:break-word;">基于Docker持续交付平台建设的实践</h1><div style="display:flex;-webkit-box-align:center;align-items:center;"><div style="display:flex;-webkit-box-align:center;align-items:center;-webkit-box-flex:1;flex:1 1 0%;white-space:nowrap;overflow:hidden;"><span><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/dockersky" style="color:inherit;text-decoration:none;" target="_blank"><img src="docker_cicd_files/v2-71a0c19a8446f553334057f6f2defe6e_l.jpg" type="image/jpeg" data-filename="v2-71a0c19a8446f553334057f6f2defe6e_l.jpg" height="38" style="background:rgb(255, 255, 255);border-radius:50%;vertical-align:top;" width="38"/></a></div></div></span><div style="-webkit-box-flex:1;flex:1 1 0%;margin-left:14px;overflow:hidden;"><div style="display:flex;-webkit-box-align:center;align-items:center;font-size:15px;line-height:1.1;flex-shrink:0;"><span style="font-weight:600;color:rgb(68, 68, 68);"><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/dockersky" style="color:inherit;text-decoration:none;" target="_blank">布道</a></div></div></span></div><div style="overflow:hidden;color:rgb(100, 100, 100);"><div style="display:flex;-webkit-box-align:center;align-items:center;margin-top:2px;font-size:14px;"><div style="word-break:break-word;line-height:1.6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgb(100, 100, 100);">Python |DevOps |Docker |架构 |安全 |运维</div></div></div></div></div></div><div><span style="color:rgb(133, 144, 166);display:block;margin-top:14px;font-size:14px;"></span></div></div><div style="overflow:hidden;width:690px;margin:0px auto;"><div style="word-break:break-word;line-height:1.6;margin-top:20px;"><blockquote style="margin:1em 0px;padding-left:1em;color:rgb(100, 100, 100);border-left:3px solid rgb(211, 211, 211);margin-top:0px;"><b style="font-weight:600;">作者：刘晓明，互联网公司运维技术负责人，拥有10年的互联网开发和运维经验。一直致力于运维工具的开发和运维专家服务的推进，赋能开发，提高效能。</b> <b style="font-weight:600;">广告时间：最后给自己代个盐~~欢迎大家有空时翻下我牌子(知乎号：布道 )，看看之前的文章，再点个赞呗，顺便关注下专栏“开发运维”。</b><br/><br/>本文已经在《程序员》杂志2017年11月刊，CSDN网站、高效运维、DevOps时代、DockerOne、Python中文社区等进行发表和转载。本文禁止转载，获取授权请联系作者！</blockquote><p style="margin:1em 0px;"><br/></p><p style="margin:1em 0px;">作为创业公司和推行DevOps工程师们来说，都遇到过这样的问题：</p><p style="margin:1em 0px;"><b style="font-weight:600;">1.</b> <b style="font-weight:600;">硬件资源利用率的问题，造成部分成本的浪费</b></p><p style="margin:1em 0px;">  在网站功能中不同的业务场景有计算型的，有IO读写型的，有网络型，有内存型的，集中部署应用就会导致资源利用率不合理的问题。比如，一个机器上部署的服务都是内存密集型，那么CPU资源就都很容易浪费了。</p><p style="margin:1em 0px;"><b style="font-weight:600;">2.</b> <b style="font-weight:600;">单物理机多应用无法对无法进行有效的隔离，导致应用对资源的抢占和相互影响</b></p><p style="margin:1em 0px;"> 一个物理机器跑多个应用，无法进行所使用的CPU，内存，进程进行限制，如果一个应用出现对资源的抢占问题，就会引起连锁反应，最终导致网站部分功能不可用。</p><p style="margin:1em 0px;"><b style="font-weight:600;">3.</b> <b style="font-weight:600;">环境、版本管理复杂，上线部署流程缺乏，增加问题排查的复杂度</b></p><p style="margin:1em 0px;">由于内部开发流程的不规范，代码在测试或者上线过程中，对一些配置项和系统参数进行随意的调整，在发布时进行增量发布，一旦出现问题，就会导致测试的代码和线上运行的代码是不一致的，增加了服务上线的风险，也增加了线上服务故障排查的难度。</p><p style="margin:1em 0px;"><b style="font-weight:600;">4.</b> <b style="font-weight:600;">环境不稳定，迁移成本高，增加上线风险</b></p><p style="margin:1em 0px;"> 在开发过程中存在多个项目并行开发和服务的依赖问题，由于环境和版本的复杂性很高，不能快速搭建和迁移一个环境，导致无法在测试环境中无法模拟出线上的流程进行测试，很多同学在线上环境进行测试，这里有很高的潜在风险，同时导致开发效率降低。</p><p style="margin:1em 0px;"><b style="font-weight:600;">5.</b> <b style="font-weight:600;">传统虚拟机和物理机占用空间大，启动慢，管理复杂等问题</b></p><p style="margin:1em 0px;"> 传统虚拟机和物理机在启动过程进行加载内核，执行内核和init进行，导致在启动过程占用很长时间，而且在管理过程中会遇到各种各样的管理问题。</p><p style="margin:1em 0px;"> 基于Docker容器技术，运维技术团队开发了五阿哥网站的容器云平台。通过容器云平台95%的应用服务已经实现容器化部署。这些应用支持业务按需拓展，秒级伸缩，提供与用户友好的交互过程，规范了测试和生产的发布流程，让开发和测试同学从基础的环境配置和发布解放出来，使其更聚焦自己的项目开发和测试。结合五阿哥容器云平台和docker容器技术的实践，本文先介绍如何实现7*24小时“一站式”的持续交付，实现产品的上线。</p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-c51d00a832d90da119e7585e1d905439_hd.jpg" type="image/jpeg" data-filename="v2-c51d00a832d90da119e7585e1d905439_hd.jpg" height="358" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="554"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">容器云平台架构图</div></div><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">Docker镜像标准化</h2><p style="margin:1em 0px;">众所周知，Docker的镜像是分层的。对镜像分层进行约定：</p><p style="margin:1em 0px;">第一层是操作系统层，由CentOS/Alpine等基础镜像构成，安装一些通用的基础组件；</p><p style="margin:1em 0px;">第二层是中间件层，根据不同的应用程序，安装它们运行时需要使用到的各种中间件和依赖软件包，如，nginx、tomcat等；</p><p style="margin:1em 0px;">第三层是应用层，这层仅包含已经打好包的各应用程序代码。</p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-5039a81afaac1149626dcbe8cd56d40a_hd.jpg" type="image/jpeg" data-filename="v2-5039a81afaac1149626dcbe8cd56d40a_hd.jpg" height="315" style="display:block;max-width:100%;margin:0px auto;" width="394"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">Docker Image分层</div></div><p style="margin:1em 0px;"><b style="font-weight:600;">经验总结：如何让自己的镜像变的更小，PUSH的更快？</b></p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-4779d4c1a4a60632041aa0caacc8548e_hd.jpg" type="image/jpeg" data-filename="v2-4779d4c1a4a60632041aa0caacc8548e_hd.jpg" height="274" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="554"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">Docker Image优化前后对比</div></div><ul style="padding:0px;margin:1em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><b style="font-weight:600;">dockerfile构建应用镜像，在中间件层遇到一些需要安装的软件包时，尽可能的使用包管理工具（如yum）或以git clone方式下载源码包进行安装，目的是将软件包的copy和安装控制在同一层，软件部署成功后清除一些无用的rpm包或源码包，让基础镜像的尺寸更小。</b></li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><b style="font-weight:600;">Java应用镜像中并没有将jdk软件包打入镜像，将jdk部署在每台宿主上，在运行镜像时，通过挂载目录的方式将宿主机上的java家目录挂载至容器指定目录下。因为它会把基础镜像撑得非常大</b>；</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><b style="font-weight:600;">在构建应用镜像时，docker会对这两层进行缓存并直接使用，仅会重新创建代码出现变动的应用层，这样就提高了应用镜像的构建速度和构建成功后向镜像仓库推送的速度，从整体流程上提升了应用的部署效率。</b></li></ul><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">容器的编排管理</h2><p style="margin:1em 0px;"><b style="font-weight:600;">编排工具的选型：</b></p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-a58c735d8fb0a6b3d2d2020bcb89cc7d_hd.jpg" type="image/jpeg" data-filename="v2-a58c735d8fb0a6b3d2d2020bcb89cc7d_hd.jpg" height="359" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="638"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">Docker编排工具对比</div></div><p style="margin:1em 0px;"><b style="font-weight:600;">Rancher图形化管理界面，部署简单、方便，<br/>可以与AD、LDAP、GITHUB集成，基于用户或用户组进行访问控制，快速将系统的编排工具升级至kubernetes或者swarm，同时有专业的技术团队进行支持，降低容器技术入门的难度。</b></p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-2d22b5c9c14421e9b45105cb0002c5e8_hd.jpg" type="image/jpeg" data-filename="v2-2d22b5c9c14421e9b45105cb0002c5e8_hd.jpg" height="348" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="554"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">Rancher架构图</div></div><p style="margin:1em 0px;">基于以上优点我们选择Rancher作为我们容器云平台的编排工具，在对应用的容器实例进行统一的编排调度时，配合Docker-Compose组件，可以在同一时间对多台宿主机执行调度操作。同时，在服务访问出现峰值和低谷时，利用特有的rancher-compose.yml文件调用“SCALE”特性，对应用集群执行动态扩容和缩容，让应用按需求处理不同的请求。<a href="https://zhuanlan.zhihu.com/p/29093407" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid gray;">https:/zhuanlan.zhihu.com/p/29093407</a></p><p style="margin:1em 0px;"><b style="font-weight:600;">容器网络模型选型：</b></p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-c1ed7e16abbaf43e13c2846124ad34ad_hd.jpg" type="image/jpeg" data-filename="v2-c1ed7e16abbaf43e13c2846124ad34ad_hd.jpg" height="258" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="554"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">Docker 网络对比</div></div><p style="margin:1em 0px;">由于后端开发基于阿里的HSF框架，生产者和消费者之间需要网络可达，对网络要求比较高，需要以真实IP地址进行注册和拉取服务。所以在选择容器网络时，我们使用了Host模式，在容器启动过程中会执行脚本检查宿主机并分配给容器一个独立的端口，来避免冲突的问题。</p><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">持续集成与持续部署</h2><p style="margin:1em 0px;">· 持续集成<br/>监测代码提交状态，对代码进行持续集成，在集成过程中执行单元测试，代码Sonar和安全工具进行静态扫描，将结果通知给开发同学同时部署集成环境，部署成功后触发自动化测试（自动化测试部分后续会更新<a href="https://zhuanlan.zhihu.com/idevops%EF%BC%89" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid gray;">）</a>。</p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-8557c6e542f5024cf2a170fd0bd38835_hd.jpg" type="image/jpeg" data-filename="v2-8557c6e542f5024cf2a170fd0bd38835_hd.jpg" height="159" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="554"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">持续集成</div></div><p style="margin:1em 0px;">静态扫描结果：</p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-596296aa75c03e73db361ba931a4c33c_hd.jpg" type="image/jpeg" data-filename="v2-596296aa75c03e73db361ba931a4c33c_hd.jpg" height="173" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="554"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">静态扫描结果</div></div><p style="margin:1em 0px;">· <b style="font-weight:600;">持续部署</b>，是一种能力，这种能力非常重要，把一个包快速部署在你想要的地方。平台采用分布式构建、部署，master管理多个slave节点，每个slave节点分属不同的环境。在master上安装并更新插件、创建job、管理各开发团队权限。slave用于执行job。</p><div style="margin:1em 0px;"><img src="docker_cicd_files/v2-6ffa5e224c501e6f7fbe98aacba7ecef_hd.jpg" type="image/jpeg" data-filename="v2-6ffa5e224c501e6f7fbe98aacba7ecef_hd.jpg" height="336" style="display:block;max-width:100%;margin:0px auto;cursor:zoom-in;" width="607"/><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">持续部署</div></div><p style="margin:1em 0px;">基于上述架构，我们定义了持续部署规范的流程：</p><p style="margin:1em 0px;">（1）开发同学向gitlab提交代码；</p><p style="margin:1em 0px;">（2）拉取项目代码和配置项文件，执行编译任务；</p><p style="margin:1em 0px;">（3）拉取基础镜像，将编译好的应用包打入生成最新的应用镜像，推送到镜像仓库；</p><p style="margin:1em 0px;">（4）根据当前应用及所属环境定制化生成docker-compose.yml文件，基于这个文件执行rancher-compose命令，将应用镜像部署到预发环境（发布生产前的测试环境，相关配置、服务依赖关系和生产环境一致）。</p><p style="margin:1em 0px;">（5）预发环境测试通过后将应用镜像部署至线上环境，测试结果通知后端测试同学。</p><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">容器的运行管理</h2><p style="margin:1em 0px;">应用容器现在已经部署到线上环境，那么在整个容器的生命周期中，还需要解决下面两个问题：</p><p style="margin:1em 0px;">（1） 如何保存应用程序产生的运行日志和其它业务日志；</p><p style="margin:1em 0px;">（2） 如何在后端服务出现变化后nginx能够自动发现并完成配置更新。</p><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">日志管理</h2><p style="margin:1em 0px;">容器在运行时会在只读层之上创建读写层，所有对应用程序的写操作都在这层进行。当容器重启后，读写层中的数据（包含日志）也会一并被清除。虽然可以通过将容器中日志目录挂载到宿主机解决此类问题，但当容器在多个宿主机间频繁漂移时，每个宿主机上都会有留存应用名的部分日志，增加了开发同学查看、排查问题的难度。</p><p style="margin:1em 0px;">综上所属，日志服务平台作为五阿哥网站日志仓库，将应用运行过程中产生的日志统一存储，并且支持多种方式的查询操作。</p><div style="margin:1em 0px;"><span><div style="position:relative;display:block;width:554px;height:339px;overflow:hidden;background-color:rgb(246, 246, 246);max-width:100%;margin:0px auto;cursor:zoom-in;"><div style="transition:opacity 0.3s ease-in;z-index:1;background-size:cover;background-position:50% center;background-repeat:no-repeat;bottom:0px;position:absolute;top:0px;right:0px;left:0px;opacity:1;"><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;background-color:rgb(255, 255, 255);opacity:0.32;"></span><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;filter:blur(16px);background-image:inherit;background-size:cover;background-position:50% center;"></span></div></div></span><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">日志管理</div></div><p style="margin:1em 0px;">通过在日志服务的管理界面配置日志采集路径，在容器中部署agent把应用日志统一投递到logstore中，再在logstore中配置全文索引和分词符，以便开发同学能够通过关键字搜索、查询想要的日志内容。</p><p style="margin:1em 0px;"><b style="font-weight:600;">经验总结：如何避免日志的重复采集问题？</b></p><p style="margin:1em 0px;"><b style="font-weight:600;">日志服务的agent需要在配置文件“ilogtail_config.json”中增加配置参数“check_point_filename”，指定checkpoint文件生成的绝对路径，并且将此路径挂载至宿主机目录下，确保容器在重启时不会丢失checkpoint文件，不会出现重复采集问题。</b></p><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">服务的注册</h2><p style="margin:1em 0px;">etcd是一个具备高可用性和强一致性的键值存储仓库，它使用类似于文件系统的树形结构，数据全部以“/”开头。etcd的数据分为两种类型：key和directories，其中key下存储单独的字符串值，directories下则存放key的集合或者其他子目录。</p><div style="margin:1em 0px;"><span><div style="position:relative;display:block;width:554px;height:188px;overflow:hidden;background-color:rgb(246, 246, 246);max-width:100%;margin:0px auto;cursor:zoom-in;"><div style="transition:opacity 0.3s ease-in;z-index:1;background-size:cover;background-position:50% center;background-repeat:no-repeat;bottom:0px;position:absolute;top:0px;right:0px;left:0px;opacity:1;"><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;background-color:rgb(255, 255, 255);opacity:0.32;"></span><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;filter:blur(16px);background-image:inherit;background-size:cover;background-position:50% center;"></span></div></div></span><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">应用注册</div></div><p style="margin:1em 0px;">在五阿哥环境中，每个向etcd注册的应用服务，它们的根目录都以”/${APP_NAME}_${ENVIRONMENT}”命名。根目录下存储每个应用实例的Key信息，它们都以“${IP}-${PORT}”的方式命名。</p><p style="margin:1em 0px;">下图是使用上述约定，存储在etcd上某应用实例的数据结构：</p><div style="margin:1em 0px;"><span><div style="position:relative;display:block;width:474px;height:285px;overflow:hidden;background-color:rgb(246, 246, 246);max-width:100%;margin:0px auto;cursor:zoom-in;"><div style="transition:opacity 0.3s ease-in;z-index:1;background-size:cover;background-position:50% center;background-repeat:no-repeat;bottom:0px;position:absolute;top:0px;right:0px;left:0px;opacity:1;"><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;background-color:rgb(255, 255, 255);opacity:0.32;"></span><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;filter:blur(16px);background-image:inherit;background-size:cover;background-position:50% center;"></span></div></div></span><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">etcd数据存储结构</div></div><p style="margin:1em 0px;">可以看到我是使用get方法向etcd发送请求的，请求的是部署在预发环境（PRE）的搜索服务（search）；在它的根目录“/search_PRE”下，仅存储了一个应用实例的信息，这个实例的key是“172.18.100.31-86”；对应的value是“172.18.100.31:86‘’，整个注册过程是这样的：</p><p style="margin:1em 0px;">① 通过代码为容器应用程序生成随机端口，和宿主机正在使用的端口进行比对，确保端口没有冲突后写入程序配置文件；</p><p style="margin:1em 0px;">② 把通过python和etcd模块编写的服务注册工具集成在脚本中，将IP地址和上一步获取的随机端口以参数的方式传递给服务注册工具；</p><p style="margin:1em 0px;">③ 待应用程序完全启动后，由服务注册工具以约定好的数据结构将应用实例的写入etcd集群，完成服务注册工作；</p><p style="margin:1em 0px;">④ 容器定时向etcd发送心跳，报告存活并刷新ttl时间；</p><p style="margin:1em 0px;">⑤ 容器脚本捕获rancher发送至应用实例的singnal terminal信号，在接收到信号后向etcd发送delete请求删除实例的数据。</p><p style="margin:1em 0px;">注：在ttl基础上增加主动清除功能，在服务正常释放时，可以立刻清除etcd上注册信息，不必等待ttl时间。</p><p style="margin:1em 0px;"><b style="font-weight:600;">经验总结：容器在重启或者意外销毁时，让我们一起看一下这个过程中容器和注册中心都做了什么事情？</b></p><p style="margin:1em 0px;"><b style="font-weight:600;">应用在注册是携带key<br/>和value时携带了ttl超时属性，就是考虑到当服务集群中的实例宕机后，它在etcd中注册的信息也随之失效，若不予清除，失效的信息将会成为垃圾数据被一直保存，而且配置管理工具还会把它当做正常数据读取出来，写入web server的配置文件中。要保证存储在etcd中的数据始终有效，就需要让etcd主动释放无效的实例信息，来看一下注册中心刷新的机制，代码直接奉上：</b></p><div style="margin:1em 0px;"><pre style="margin:0px;padding:0.88889em;font-size:0.9em;word-wrap:normal;white-space:pre;overflow:auto;background:rgb(246, 246, 246);border-radius:4px;"><code style="font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;margin:0px;padding:0px;border-radius:0px;font-size:inherit;background-color:inherit;"><span></span>#!/usr/bin/env
python
import etcd
import sys
arg_l=sys.argv[1:]
etcd_clt=etcd.Client(host='172.18.0.7')
def
set_key(key,value,ttl=10):
try:
return
etcd_clt.write(key,value,ttl)
except TypeError:
print 'key or vlaue is null'
def
refresh_key(key,ttl=10):
try:
return
etcd_clt.refresh(key,ttl)
except TypeError:
 print 'key is null'
def
del_key(key):
try:
return etcd_clt.delete(key)
except TypeError:
print 'key is null'
if arg_l:
if len(arg_l) == 3:
key,value,ttl=arg_l
set_key(key,value,ttl)
elif len(arg_l) == 2:
key,ttl=arg_l
refresh_key(key,ttl)
elif len(arg_l) == 1:
key=arg_l[0]
del_key(key)
else:
raise TypeError,'Only three
parameters are needed here'
else:
raise Exception('args is null')
</code></pre></div><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">服务的发现</h2><p style="margin:1em 0px;">confd是一个轻量级的配置管理工具，支持etcd作为后端数据源，通过读取数据源数据，保证本地配置文件为最新；不仅如此 ，它还可以在配置文件更新后，检查配置文件语法有效性，以重新加载应用程序使配置生效。这里需要说明的是，confd虽然支持rancher作为数据源，但考虑易用性和扩展性等原因，最终我们还是选择了etcd。</p><p style="margin:1em 0px;">和大多数部署方式一样，我们把confd部署在web server所在的ECS上，便于confd在监测到数据变化后及时更新配置文件和重启程序。confd的相关配置文件和模板文件部署在默认路径/etc/confd下，目录结构如下：</p><div style="margin:1em 0px;"><pre style="margin:0px;padding:0.88889em;font-size:0.9em;word-wrap:normal;white-space:pre;overflow:auto;background:rgb(246, 246, 246);border-radius:4px;"><code style="font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;margin:0px;padding:0px;border-radius:0px;font-size:inherit;background-color:inherit;"><span></span>/etc/confd/
├── conf.d
├── confd.toml
└── templates
</code></pre></div><p style="margin:1em 0px;">confd.toml是confd的主配置文件，使用TOML格式编写，因为我们etcd是集群部署，有多个节点，而我又不想把confd的指令搞的又臭又长，所以将interval、nodes等选项写到了这个配置文件里。</p><p style="margin:1em 0px;">cond.d目录存放web server的模板配置源文件，也使用TOML格式编写。该文件用于指定应用模板配置文件路径（src）、应用配置文件路径（dest）、数据源的key信息（keys）等。</p><p style="margin:1em 0px;">templates目录存放web server下每个应用的模板配置文件。它使用Go支持的text/template语言格式进行编写。在confd从etcd中读取到最新应用注册信息后，通过下面的语句写入模板配置文件中：</p><div style="margin:1em 0px;"><pre style="margin:0px;padding:0.88889em;font-size:0.9em;word-wrap:normal;white-space:pre;overflow:auto;background:rgb(246, 246, 246);border-radius:4px;"><code style="font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;margin:0px;padding:0px;border-radius:0px;font-size:inherit;background-color:inherit;"><span></span>{{range getvs &quot;/${APP_NAME}/*&quot;}}
server {{.}};
{{end}}
</code></pre></div><div style="margin:1em 0px;"><span><div style="position:relative;display:block;width:535px;height:200px;overflow:hidden;background-color:rgb(246, 246, 246);max-width:100%;margin:0px auto;cursor:zoom-in;"><div style="transition:opacity 0.3s ease-in;z-index:1;background-size:cover;background-position:50% center;background-repeat:no-repeat;bottom:0px;position:absolute;top:0px;right:0px;left:0px;opacity:1;"><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;background-color:rgb(255, 255, 255);opacity:0.32;"></span><span style="position:absolute;top:0px;right:0px;bottom:0px;left:0px;display:block;filter:blur(16px);background-image:inherit;background-size:cover;background-position:50% center;"></span></div></div></span><div style="margin-top:0.66667em;padding:0px 1em;font-size:0.9em;line-height:1.5;text-align:center;color:rgb(153, 153, 153);">服务发现</div></div><p style="margin:1em 0px;">通过supervisor管理confd进程。confd在运行后会每隔5秒对etcd进行轮询，当某个应用服务的K/V更新后，confd会读取该应用存储在etcd中的数据，写入到模板配置文件中，生成这个应用配置文件，最后由confd将配置文件写入到目标路径下，重新加载nginx程序使配置生效。</p><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;font-family:inherit;font-weight:600;font-size:1.2em;line-height:1.5;margin-top:1.66667em;margin-bottom:0.83333em;">总结</h2><p style="margin:1em 0px;">本文是五阿哥运维技术团队针对Docker容器技术在如何在持续交付过程中探索和实践，目前已经将发布部署权限开放给应用开发的owner，实现7*24小时“一站式”的持续交付，整体提高了公司的研发过程的交付能力。</p><p style="margin:1em 0px;">接下来会不断优化持续交付过程中遇到的各种场景，逐渐完善容器云平台，同时会将容器云平台各种功能，总结的经验和教训不断分享给大家，给大家在工作中一些参考，避免走重复的“弯路”。</p><p style="margin:1em 0px;"><br/></p><hr style="margin:4em auto;width:240px;max-width:100%;border-right:none;border-bottom:none;border-left:none;border-image:initial;border-top:1px solid rgb(211, 211, 211);"/><p style="margin:1em 0px;"><b style="font-weight:600;">更多精彩请点击：</b></p><p style="margin:1em 0px;"><a href="https://zhuanlan.zhihu.com/p/31182175" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid gray;">用 Python 分析胡歌的《猎场》到底值不值得看？</a></p><p style="margin:1em 0px;"><a href="https://zhuanlan.zhihu.com/p/30475175" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid gray;">XSS常见攻击与防御</a></p><p style="margin:1em 0px;"><a href="https://zhuanlan.zhihu.com/p/30061051" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid gray;">利用500W条微博语料对评论进行情感分析</a></p><p style="margin:1em 0px;"><a href="https://zhuanlan.zhihu.com/p/29787843" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid gray;">还在手调网络权限？资深IT工程师都这样玩企业组网</a></p><p style="margin:1em 0px;margin-bottom:0px;"><a href="https://zhuanlan.zhihu.com/p/29758427" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid gray;">微服务在互联网公司演进过程</a></p></div></div><div style="font-size:14px;color:rgb(133, 144, 166);padding:16px 0px;overflow:hidden;width:690px;margin:0px auto;"><a href="http://zhuanlan.zhihu.com/p/31760826" style="color:inherit;text-decoration:none;" target="_blank"><span>编辑于 2017-12-17</span></a></div><div style="overflow:hidden;width:690px;margin:0px auto;display:flex;"><div style="display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;flex-flow:row wrap;-webkit-box-align:center;align-items:center;margin-bottom:-10px;padding:16px 0px;"><div style="color:rgb(0, 132, 255);position:relative;background:rgba(0, 132, 255, 0.1);padding:0px 12px;border-radius:100px;vertical-align:top;display:inline-block;line-height:33px;font-size:13px;height:33px;overflow:hidden;margin-bottom:10px;margin-right:5px;"><span><a href="https://www.zhihu.com/topic/19950993" style="color:inherit;text-decoration:none;" target="_blank"><div style="position:relative;display:inline-block;"><div>Docker</div></div></a></span></div><div style="color:rgb(0, 132, 255);position:relative;background:rgba(0, 132, 255, 0.1);padding:0px 12px;border-radius:100px;display:inline-block;line-height:33px;vertical-align:middle;font-size:13px;height:33px;overflow:hidden;margin-bottom:10px;margin-right:5px;"><span><a href="https://www.zhihu.com/topic/19791242" style="color:inherit;text-decoration:none;" target="_blank"><div style="position:relative;display:inline-block;"><div>DevOps</div></div></a></span></div><div style="color:rgb(0, 132, 255);position:relative;background:rgba(0, 132, 255, 0.1);padding:0px 12px;border-radius:100px;display:inline-block;line-height:33px;vertical-align:middle;font-size:13px;height:33px;overflow:hidden;margin-bottom:10px;"><span><a href="https://www.zhihu.com/topic/19560830" style="color:inherit;text-decoration:none;" target="_blank"><div style="position:relative;display:inline-block;"><div>运维</div></div></a></span></div></div></div><div style="overflow:hidden;width:690px;margin:0px auto;"><div style="visibility:hidden;position:static;top:auto;right:auto;bottom:0px;left:0px;display:block;float:none;margin:0px 0px 10px;height:54px;"></div></div><div style="padding-top:30px;overflow:hidden;width:690px;margin:0px auto;margin-bottom:-8px;"><h3 style="font-family:inherit;margin:0px;font-variant:inherit;font-style:inherit;font-stretch:inherit;font-size:16px;line-height:1.375;font-weight:600;color:rgb(26, 26, 26);border-color:rgb(235, 235, 235);border-bottom-style:solid;border-width:1px;padding-bottom:12px;margin-top:0px;">文章被以下专栏收录</h3><ul style="padding:0px;margin:0px;"><div style="margin:24px 0px;"><div style="display:flex;height:40px;"><div style="float:left;margin-right:16px;"><a href="https://zhuanlan.zhihu.com/idevops" style="color:inherit;text-decoration:none;"><div style="position:relative;display:inline-block;"><div><img src="docker_cicd_files/v2-f4ba0f95646c192f25de2cc2805568fd_l.jpg" type="image/jpeg" data-filename="v2-f4ba0f95646c192f25de2cc2805568fd_l.jpg" height="40" style="background:rgb(255, 255, 255);border-radius:50%;" width="40"/></div></div></a></div><div style="-webkit-box-flex:1;flex:1 1 0%;overflow:hidden;margin-right:6px;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-box-pack:center;justify-content:center;"><h2 style="line-height:1.6;margin:0px;font-variant:inherit;font-weight:600;font-stretch:inherit;font-size:15px;font-style:inherit;font-family:inherit;color:rgb(68, 68, 68);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="https://zhuanlan.zhihu.com/idevops" style="color:inherit;text-decoration:none;"><div style="position:relative;display:inline-block;"><div>开发运维</div></div></a></h2></div><div style="align-self:center;"><a href="https://zhuanlan.zhihu.com/idevops" style="text-align:center;text-decoration:none;font-size:14px;line-height:32px;color:rgb(133, 144, 166);padding:0px 16px;cursor:pointer;background:none;border:1px solid;border-radius:3px;display:inline-block;" type="button">进入专栏</a></div></div></div><div style="margin:24px 0px;"><div style="display:flex;height:40px;"><div style="float:left;margin-right:16px;"><a href="https://zhuanlan.zhihu.com/zimei" style="color:inherit;text-decoration:none;"><div style="position:relative;display:inline-block;"><div><img src="docker_cicd_files/v2-29d994e518953cade86704e66aef3701_l.jpg" type="image/jpeg" data-filename="v2-29d994e518953cade86704e66aef3701_l.jpg" height="40" style="background:rgb(255, 255, 255);border-radius:50%;" width="40"/></div></div></a></div><div style="-webkit-box-flex:1;flex:1 1 0%;overflow:hidden;margin-right:6px;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-box-pack:center;justify-content:center;"><h2 style="line-height:1.6;margin:0px;font-variant:inherit;font-weight:600;font-stretch:inherit;font-size:15px;font-style:inherit;font-family:inherit;color:rgb(68, 68, 68);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="https://zhuanlan.zhihu.com/zimei" style="color:inherit;text-decoration:none;"><div style="position:relative;display:inline-block;"><div>Python中文社区</div></div></a></h2><div style="margin-top:0px;font-size:14px;color:rgb(100, 100, 100);line-height:1.5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">微信公众号同名，欢迎投稿。全平台约20万开发者关注，会员来自全球十多个国家和地区，拥有十多个线上线下技术社群，向本专栏投稿即默认发布到Python中文社区全平台。GitHub：github.com/pycn</div></div><div style="align-self:center;"><a href="https://zhuanlan.zhihu.com/zimei" style="text-align:center;text-decoration:none;font-size:14px;line-height:32px;color:rgb(133, 144, 166);padding:0px 16px;cursor:pointer;background:none;border:1px solid;border-radius:3px;display:inline-block;" type="button">进入专栏</a></div></div></div></ul></div><div style="background:rgb(246, 246, 246);position:relative;overflow:hidden;margin:24px auto;width:1266px;"><h3 style="font-family:inherit;margin:0px;font-variant:inherit;font-style:inherit;font-stretch:inherit;font-size:16px;line-height:1.375;font-weight:600;color:rgb(26, 26, 26);border-color:rgb(235, 235, 235);border-bottom-style:solid;border-width:1px;padding-bottom:12px;margin-top:40px;">推荐阅读</h3><ul style="padding:0px;margin:32px auto;display:flex;-webkit-box-pack:center;justify-content:center;"><a href="http://zhuanlan.zhihu.com/p/38402827" style="box-shadow:rgba(26, 26, 26, 0.06) 0px 6px 14px 0px;color:inherit;text-decoration:none;width:245px;min-width:245px;border-radius:5px;height:226px;background:rgb(255, 255, 255);margin-right:14px;position:relative;overflow:hidden;transition:transform 0.3s, -webkit-transform 0.3s;"><div><img src="docker_cicd_files/v2-e38173a70f2399e88f2870f07d8f7508_qhd.jpg" type="image/jpeg" data-filename="v2-e38173a70f2399e88f2870f07d8f7508_qhd.jpg" height="123" style="height:123px;width:245px;object-fit:cover;border-top-left-radius:5px;border-top-right-radius:5px;" width="245"/><h1 style="font-family:inherit;margin:12px;font-variant:inherit;font-weight:600;font-stretch:inherit;font-size:16px;line-height:22px;font-style:inherit;min-width:225px;color:rgb(26, 26, 26);display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-line-clamp:2;-webkit-box-orient:vertical;">Docker轻松入门（详解）</h1><div style="position:absolute;bottom:12px;left:12px;display:flex;-webkit-box-pack:justify;justify-content:space-between;width:100%;font-size:14px;color:rgb(133, 144, 166);line-height:20px;"><span>慕课网</span><span style="margin-right:24px;"></span></div></div></a><a href="http://zhuanlan.zhihu.com/p/36201147" style="box-shadow:rgba(26, 26, 26, 0.06) 0px 6px 14px 0px;color:inherit;text-decoration:none;width:245px;min-width:245px;border-radius:5px;height:226px;background:rgb(255, 255, 255);margin-right:14px;position:relative;overflow:hidden;transition:transform 0.3s, -webkit-transform 0.3s;"><div><img src="docker_cicd_files/v2-2216bd3b029fbf0a8faf192138dc9313_qhd.jpg" type="image/jpeg" data-filename="v2-2216bd3b029fbf0a8faf192138dc9313_qhd.jpg" height="123" style="height:123px;width:245px;object-fit:cover;border-top-left-radius:5px;border-top-right-radius:5px;" width="245"/><h1 style="font-family:inherit;margin:12px;font-variant:inherit;font-weight:600;font-stretch:inherit;font-size:16px;line-height:22px;font-style:inherit;min-width:225px;color:rgb(26, 26, 26);display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-line-clamp:2;-webkit-box-orient:vertical;">使用 Docker 搭建本地 https 环境</h1><div style="position:absolute;bottom:12px;left:12px;display:flex;-webkit-box-pack:justify;justify-content:space-between;width:100%;font-size:14px;color:rgb(133, 144, 166);line-height:20px;"><span>苏依</span><span style="margin-right:24px;"></span></div></div></a><a href="http://zhuanlan.zhihu.com/p/30788072" style="box-shadow:rgba(26, 26, 26, 0.06) 0px 6px 14px 0px;color:inherit;text-decoration:none;width:245px;min-width:245px;border-radius:5px;height:226px;background:rgb(255, 255, 255);margin-right:14px;position:relative;overflow:hidden;transition:transform 0.3s, -webkit-transform 0.3s;"><div><img src="docker_cicd_files/v2-8c8679fa47341637bb2d7e89853947fe_qhd.jpg" type="image/jpeg" data-filename="v2-8c8679fa47341637bb2d7e89853947fe_qhd.jpg" height="123" style="height:123px;width:245px;object-fit:cover;border-top-left-radius:5px;border-top-right-radius:5px;" width="245"/><h1 style="font-family:inherit;margin:12px;font-variant:inherit;font-weight:600;font-stretch:inherit;font-size:16px;line-height:22px;font-style:inherit;min-width:225px;color:rgb(26, 26, 26);display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-line-clamp:2;-webkit-box-orient:vertical;">为什么要在 Docker 中使用 R？ 一位 DevOps 的看法</h1><div style="position:absolute;bottom:12px;left:12px;display:flex;-webkit-box-pack:justify;justify-content:space-between;width:100%;font-size:14px;color:rgb(133, 144, 166);line-height:20px;"><span>Linux...</span><span style="margin-right:24px;">发表于Linux...</span></div></div></a><a href="http://zhuanlan.zhihu.com/p/25554362" style="box-shadow:rgba(26, 26, 26, 0.06) 0px 6px 14px 0px;color:inherit;text-decoration:none;width:245px;min-width:245px;border-radius:5px;height:226px;background:rgb(255, 255, 255);margin-right:14px;position:relative;overflow:hidden;transition:transform 0.3s, -webkit-transform 0.3s;"><div><h1 style="font-family:inherit;margin:12px;font-variant:inherit;font-weight:600;font-stretch:inherit;font-size:16px;line-height:22px;font-style:inherit;min-width:225px;color:rgb(26, 26, 26);display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-line-clamp:2;-webkit-box-orient:vertical;">推荐两篇关于Docker的文章</h1><p style="margin:8px 12px;font-size:14px;color:rgb(26, 26, 26);line-height:20px;display:-webkit-box;-webkit-line-clamp:6;-webkit-box-orient:vertical;max-height:118px;overflow:hidden;">鉴于最近踩到的一些Docker的坑，推荐两篇同一个人最近写的文章，某些观点于我心有戚戚焉。 Docker in Production: A History of Failure (发表于2016-11-01) The docker release cycle is t…</p><div style="position:absolute;bottom:12px;left:12px;display:flex;-webkit-box-pack:justify;justify-content:space-between;width:100%;font-size:14px;color:rgb(133, 144, 166);line-height:20px;"><span>rlei</span><span style="margin-right:24px;">发表于I Obj...</span></div></div></a></ul></div><div style="height:100%;overflow:hidden;width:690px;border-top:52px solid transparent;margin:-52px auto 0px;"><div style="box-sizing:border-box;height:100%;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;overflow:visible;display:flex;border-radius:4px;background:rgb(255, 255, 255);box-shadow:none;border:none;margin:0px;"><div style="background:rgb(255, 255, 255);border-bottom:1px solid rgb(246, 246, 246);display:flex;-webkit-box-pack:justify;justify-content:space-between;-webkit-box-align:center;align-items:center;height:50px;padding:0px;border-radius:2px;"><div style="-webkit-box-flex:1;flex:1 1 0%;"><h2 style="margin:0px;font-style:inherit;font-variant:inherit;font-stretch:inherit;line-height:inherit;font-family:inherit;font-weight:600;font-size:15px;display:inline-block;color:rgb(26, 26, 26);">5 条评论</h2></div><div></div></div><div style="position:relative;transition:padding-right 0.3s ease;padding:12px 20px;background:rgb(255, 255, 255);border-top:none;"><div style="background:rgb(255, 255, 255);position:relative;transition:background 0.2s, border 0.2s;box-sizing:border-box;border-radius:3px;font-size:15px;display:flex;border:1px solid rgb(235, 235, 235);padding:0px;height:auto;width:100%;overflow:hidden;"><div style="font-weight:inherit;-webkit-box-flex:1;padding:0px;overflow:hidden;font-family:inherit;font-size:inherit;flex:1 1 0%;resize:none;border:none;outline:none;background:rgb(246, 246, 246);line-height:24px;"><div style="word-break:break-word;line-height:1.6;position:relative;cursor:text;min-height:198px;"><div style="height:auto;margin-top:0px;margin-bottom:0px;padding:5px 12px;"><div style="position:absolute;pointer-events:none;color:rgb(133, 144, 166);"><div style="white-space:pre-wrap;">写下你的评论...</div></div><div><div style="outline:none;user-select:text;white-space:pre-wrap;word-wrap:break-word;"><div><div style="margin:0px;"><div><span><br/></span></div></div></div></div></div></div></div><div></div></div></div></div><div><div style="-webkit-box-flex:1;flex:1 1 0%;overflow-x:hidden;overflow-y:visible;"><div style="position:relative;flex-shrink:0;padding:12px 20px 10px;font-size:15px;outline:none;"><div><div style="position:relative;height:27px;padding-right:3px;padding-left:1px;margin-bottom:5px;line-height:24px;"><span style="margin-right:8px;"><img src="docker_cicd_files/da8e974dc_xs.jpg" type="image/jpeg" data-filename="da8e974dc_xs.jpg" height="24" style="background:rgb(255, 255, 255);border-radius:2px;vertical-align:top;" width="24"/></span><span>知乎用户</span><span style="float:right;font-size:14px;color:rgb(133, 144, 166);">9 个月前</span></div><div style="word-break:break-word;line-height:25px;margin-bottom:6px;"><p style="margin:0px;margin-top:0px;margin-bottom:0px;">话说看这类文章往往会陷入一种看完就就是看完了的困境中。是我意境未到？</p></div><div style="display:flex;-webkit-box-align:center;align-items:center;height:24px;font-size:14px;line-height:24px;"></div></div></div><div style="position:relative;flex-shrink:0;padding:12px 20px 10px;font-size:15px;outline:none;"><div><div style="position:relative;height:27px;padding-right:3px;padding-left:1px;margin-bottom:5px;line-height:24px;"><span style="margin-right:8px;"><img src="docker_cicd_files/da8e974dc_xs [1].jpg" type="image/jpeg" data-filename="da8e974dc_xs.jpg" height="24" style="background:rgb(255, 255, 255);border-radius:2px;vertical-align:top;" width="24"/></span><span>知乎用户</span><span style="float:right;font-size:14px;color:rgb(133, 144, 166);">9 个月前</span></div><div style="word-break:break-word;line-height:25px;margin-bottom:6px;"><p style="margin:0px;margin-top:0px;margin-bottom:0px;">没看懂，写的什么</p></div><div style="display:flex;-webkit-box-align:center;align-items:center;height:24px;font-size:14px;line-height:24px;"></div></div><span style="font-size:15px;position:absolute;top:0px;left:0px;right:0px;display:block;margin:0px 16px;border-bottom:1px solid rgb(246, 246, 246);"></span></div><div style="position:relative;flex-shrink:0;padding:12px 20px 10px;font-size:15px;outline:none;"><div><div style="position:relative;height:27px;padding-right:3px;padding-left:1px;margin-bottom:5px;line-height:24px;"><span style="margin-right:8px;"><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/mo-fei-56-94" style="color:inherit;text-decoration:none;" target="_blank"><img src="docker_cicd_files/3d5f5f535a9096b17e243ca083cdc20c_xs.jpg" type="image/jpeg" data-filename="3d5f5f535a9096b17e243ca083cdc20c_xs.jpg" height="24" style="background:rgb(255, 255, 255);border-radius:2px;vertical-align:top;" width="24"/></a></div></div></span><span><a href="https://www.zhihu.com/people/mo-fei-56-94" style="color:inherit;text-decoration:none;" target="_blank">莫飞</a></span><span style="float:right;font-size:14px;color:rgb(133, 144, 166);">9 个月前</span></div><div style="word-break:break-word;line-height:25px;margin-bottom:6px;">“Java应用镜像中并没有将jdk软件包打入镜像，将jdk部署在每台宿主上，在运行镜像时，通过挂载目录的方式将宿主机上的java家目录挂载至容器指定目录下。因为它会把基础镜像撑得非常大；”<br style="margin-top:0px;"/><br style="margin-bottom:0px;"/>这种操作我试了，不ok，运行时把JAVA_HOME挂载到容器上，在容器里还是无法使用java命令，是我操作姿势不对吗？！求解。</div><div style="display:flex;-webkit-box-align:center;align-items:center;height:24px;font-size:14px;line-height:24px;"></div></div><span style="font-size:15px;position:absolute;top:0px;left:0px;right:0px;display:block;margin:0px 16px;border-bottom:1px solid rgb(246, 246, 246);"></span></div><div style="position:relative;flex-shrink:0;padding:12px 20px 10px;font-size:15px;outline:none;"><div><div style="position:relative;height:27px;padding-right:3px;padding-left:1px;margin-bottom:5px;line-height:24px;"><span style="margin-right:8px;"><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/zhang-hao-wei-14" style="color:inherit;text-decoration:none;" target="_blank"><img src="docker_cicd_files/a059351c907927b6163c8502ee88c44a_xs.jpg" type="image/jpeg" data-filename="a059351c907927b6163c8502ee88c44a_xs.jpg" height="24" style="background:rgb(255, 255, 255);border-radius:2px;vertical-align:top;" width="24"/></a></div></div></span><span><a href="https://www.zhihu.com/people/zhang-hao-wei-14" style="color:inherit;text-decoration:none;" target="_blank">张浩威</a></span><span style="float:right;font-size:14px;color:rgb(133, 144, 166);">7 个月前</span></div><div style="word-break:break-word;line-height:25px;margin-bottom:6px;"><p style="margin:0px;margin-top:0px;margin-bottom:0px;">我也意境未到</p></div><div style="display:flex;-webkit-box-align:center;align-items:center;height:24px;font-size:14px;line-height:24px;"></div></div><span style="font-size:15px;position:absolute;top:0px;left:0px;right:0px;display:block;margin:0px 16px;border-bottom:1px solid rgb(246, 246, 246);"></span></div><div style="position:relative;flex-shrink:0;padding:12px 20px 10px;font-size:15px;outline:none;"><div><div style="position:relative;height:27px;padding-right:3px;padding-left:1px;margin-bottom:5px;line-height:24px;"><span style="margin-right:8px;"><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/peng-peng-28-58" style="color:inherit;text-decoration:none;" target="_blank"><img src="docker_cicd_files/8025e299539209b32ba7cc9a4b5cb4dc_xs.jpg" type="image/jpeg" data-filename="8025e299539209b32ba7cc9a4b5cb4dc_xs.jpg" height="24" style="background:rgb(255, 255, 255);border-radius:2px;vertical-align:top;" width="24"/></a></div></div></span><span><a href="https://www.zhihu.com/people/peng-peng-28-58" style="color:inherit;text-decoration:none;" target="_blank">鹏鹏</a></span><span><span style="color:rgb(133, 144, 166);margin-right:8px;margin-left:8px;">回复</span><span><a href="https://www.zhihu.com/people/mo-fei-56-94" style="color:inherit;text-decoration:none;" target="_blank">莫飞</a></span></span><span style="float:right;font-size:14px;color:rgb(133, 144, 166);">7 个月前</span></div><div style="word-break:break-word;line-height:25px;margin-bottom:6px;">我不太明白你的意思？是说我把宿主机bin目录映射到容器内就能用bin的一些命令？就算可以，这不是破坏当初容器隔离设计的初衷了吗？如果是映射打包的文件，那就是额外的扩展包，和能不能执行java命令又有什么关系？</div><div style="display:flex;-webkit-box-align:center;align-items:center;height:24px;font-size:14px;line-height:24px;"></div></div><span style="font-size:15px;position:absolute;top:0px;left:0px;right:0px;display:block;margin:0px 16px;border-bottom:1px solid rgb(246, 246, 246);"></span></div></div><span></span></div></div></div></div></div></span></div></div></div></div></div>
</div>
</span>
</div></body></html> 