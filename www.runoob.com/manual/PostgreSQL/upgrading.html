<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>升级一个 PostgreSQL 集群</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="服务器设置和操作" HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime.html"><LINK REL="PREVIOUS" TITLE="关闭服务器" HREF="server-shutdown.html"><LINK REL="NEXT" TITLE="防止服务器欺骗" HREF="preventing-server-spoofing.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/runtime.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="关闭服务器" HREF="server-shutdown.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 17. 服务器设置和操作</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="防止服务器欺骗" HREF="preventing-server-spoofing.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="UPGRADING">17.6. 升级一个 <SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 集群</A></H1><P>本节讨论怎样从一个<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>发布到一个新的发布升级你的数据库数据。</P><P><SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>主要版本由前两个数字的版本号代表，例如8.4。
<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>主要版本由前三个数字的版本号代表，例如8.4.2是第二个8.4的维护性发布。
维护性发布从不改变内部存储器格式并且总是与之前的和之后的相同维护性版本号的维护性版本兼容，
例如8.4.2兼容8.4,8.4.1和8.4.6。要在兼容的版本之间更新，在服务器关闭时简单的替换可执行文件并且重启服务器就可以。
数据目录保留不改变&mdash;维护性升级就这么简单。</P><P>对<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>的<SPAN CLASS="emphasis"><I CLASS="EMPHASIS">主要</I></SPAN>发布，内部数据存储格式是改变的主题，
因此并发升级。移动数据到一个新的主要版本的传统的方法是转储并重新加载数据库。
就像下面描述的那样，其他方法也适用。</P><P>新的主要版本还通常介绍一些用户可见的不兼容性，所以可能需要改变应用程序。
所有用户可见的改变都在版本注释里面列出（<A HREF="http://school.yunwei.edu/manual/PostgreSQL/release.html">&#38468;&#24405; E</A>）；
尤其注意章节标签"Migration"。如果你正在几个主要版本间升级，
一定要阅读每个中间版本的版本注释。</P><P>谨慎的用户可能想在全面切换前在新的版本上测试他们的客户端应用；因此，
设置并发新旧版本的安装是一个好的主意。当测试一个<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>的主要升级时，
考虑下列类别的可能变化：</P><P></P><DIV CLASS="VARIABLELIST"><DL><DT>Administration</DT><DD><P>在每个主要版本中，管理员对服务器可用的监视和控制功能通常会改变和增加。</P></DD><DT>SQL</DT><DD><P>通常包含新的SQL命令功能而不是行为上的改变，除非在版本注释里面特别提到。</P></DD><DT>Library API</DT><DD><P>像<SPAN CLASS="APPLICATION">libpq</SPAN>这样典型的库只添加新的函数，同样除非在版本注释里面特别提到。</P></DD><DT>System Catalogs</DT><DD><P>系统目录变更通常只影响数据库管理工具。</P></DD><DT>Server C-language API</DT><DD><P>这涉及到后端函数API的变化，它是用C编程语言写的。这样的改变影响引用深层服务器后端函数的编码。</P></DD></DL></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="UPGRADE-METHODS-PGDUMP">17.6.1. 通过<SPAN CLASS="APPLICATION">pg_dump</SPAN>升级数据</A></H2><P>要从<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>的一个主要版本转储数据并加载到另一个版本，必须使用<SPAN CLASS="APPLICATION">pg_dump</SPAN>;
文件系统级备份方法将不能使用。（有检查防止你用不兼容的<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
版本使用数据目录，所以在一个数据目录上尝试启动错误的服务器版本也不会造成大的伤害。）</P><P>建议使用新版本的<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> <SPAN CLASS="APPLICATION">pg_dump</SPAN>和<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>程序，
利用这些程序可能的增强功能。当前转储程序版本可以从一直到7.0的任何服务器版本中读取数据。</P><P>这些说明假设现有的安装在<TT CLASS="FILENAME">/usr/local/pgsql</TT>目录下，数据区域在<TT CLASS="FILENAME">/usr/local/pgsql/data</TT>
目录下。适当的替代你的路径。</P><DIV CLASS="PROCEDURE"><OL TYPE="1"><LI CLASS="STEP"><P>如果做一个备份，确保数据库没有被更新。这不影响备份的完整性，但是将不会包括改变了的数据。
如果必须要这样做，那么编辑文件<TT CLASS="FILENAME">/usr/local/pgsql/data/pg_hba.conf</TT>(或相等的)里的权限，
设置除了你之外的人都不可以访问。参阅<A HREF="http://school.yunwei.edu/manual/PostgreSQL/client-authentication.html">第 19 &#31456;</A>获取关于访问控制的更多信息。</P><P>
备份你的数据库安装，输入：
</P><PRE CLASS="SCREEN"><KBD
CLASS="USERINPUT"
>pg_dumpall &gt; <TT
CLASS="REPLACEABLE"
><I
>outputfile</I
></TT
></KBD
></PRE><P>
如果您需要保存OID（例如当使用它们作为外键时），那么在运行<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>
时使用<TT CLASS="OPTION">-o</TT>选项。
</P><P>要做备份，可以使用当前运行版本的<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>命令。然而，
要获取最佳结果尝试使用<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 9.3.1的
<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>命令，因为这个版本包含bug修复和对老版本的改进。
虽然在你还没有安装新版本时这个建议看起来很特别，但是如果你打算同时安装新版本和老版本，
那么这个建议是可行的。在这种情况下你可以正常完成安装然后传送数据。这也将减少停机时间。</P></LI><LI CLASS="STEP"><P>关闭旧的服务器：
</P><PRE CLASS="SCREEN"><KBD
CLASS="USERINPUT"
>pg_ctl stop</KBD
></PRE><P>
系统上的<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>在开机时启动，可能有一个启动文件将完成同样的事情。
例如，在<SPAN CLASS="SYSTEMITEM">Red Hat Linux</SPAN>系统上，可能发现这个在工作：
</P><PRE CLASS="SCREEN"><KBD
CLASS="USERINPUT"
>/etc/rc.d/init.d/postgresql stop</KBD
></PRE><P>
参阅<A HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime.html">第 17 &#31456;</A>获取关于启动和停止服务器的详细信息。
</P></LI><LI CLASS="STEP"><P>如果从备份中恢复，重命名或者删除旧的安装目录。重命名目录是个好主意，而不是删掉它，
以防你有困难并且需要恢复它。记住，目录可能会占用大量磁盘空间。要重命名目录，使用像下面这样的命令：
</P><PRE CLASS="SCREEN"><KBD
CLASS="USERINPUT"
>mv /usr/local/pgsql /usr/local/pgsql.old</KBD
></PRE><P>
（一定要把目录作为一个单元，所以相对路径保持不变。）
</P></LI><LI CLASS="STEP"><P>像<A HREF="install-procedure.html">第 15.4 &#33410;</A>.
中概述的那样安装<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>新版本。 </P></LI><LI CLASS="STEP"><P>如果需要创建一个新的数据库集群。请记住，当登陆到特定的数据库用户账户
（如果已经升级，那么已经有这个账户了）时必须执行下面的命令。
</P><PRE CLASS="PROGRAMLISTING"><KBD
CLASS="USERINPUT"
>/usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data</KBD
></PRE><P>
</P></LI><LI CLASS="STEP"><P>恢复以前的<TT CLASS="FILENAME">pg_hba.conf</TT>和任意<TT CLASS="FILENAME">postgresql.conf</TT>修改。</P></LI><LI CLASS="STEP"><P>启动数据库服务器，再次使用特定的数据库用户账户：
</P><PRE CLASS="PROGRAMLISTING"><KBD
CLASS="USERINPUT"
>/usr/local/pgsql/bin/postgres -D /usr/local/pgsql/data</KBD
></PRE><P>
</P></LI><LI CLASS="STEP"><P>最终，从备份中恢复数据：
</P><PRE CLASS="SCREEN"><KBD
CLASS="USERINPUT"
>/usr/local/pgsql/bin/psql -d postgres -f <TT
CLASS="REPLACEABLE"
><I
>outputfile</I
></TT
></KBD
></PRE><P>
使用<SPAN CLASS="emphasis"><I CLASS="EMPHASIS">新的</I></SPAN> <SPAN CLASS="APPLICATION">psql</SPAN>
</P></LI></OL></DIV><P>
最少的停机时间可以通过在一个不同的目录下安装新的服务器，并且并行在不同的端口运行旧的和新的服务器来达到。
然后就可以使用类似：
</P><PRE CLASS="PROGRAMLISTING">pg_dumpall -p 5432 | psql -d postgres -p 5433</PRE><P>
来传送数据。
</P></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="UPGRADING-METHODS-OTHER">17.6.2. Non-Dump 升级方法</A></H2><P><A HREF="pgupgrade.html">pg_upgrade</A>模块允许安装从一个主<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>版本到下一个的迁移。
升级可以在几分钟内完成。</P><P>还可以使用特定的复制方法，比如<SPAN CLASS="PRODUCTNAME">Slony</SPAN>，创建一个更新的<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
版本备用服务器。这是可能的，因为Slony支持不同<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>主版本间的复制。
备机可以在相同的计算机上，也可以在不同的计算机上。一旦它与主服务器（在老<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
版本上运行）同步，就可以切换主机使备机成为主机，并立即关闭旧的数据库。这样的切换使升级只有几秒钟的关机时间。</P></DIV></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="server-shutdown.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="preventing-server-spoofing.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">关闭服务器</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">防止服务器欺骗</TD></TR></TABLE></DIV></BODY></HTML>
