<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>可靠性</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="可靠性和预写式日志" HREF="http://school.yunwei.edu/manual/PostgreSQL/wal.html"><LINK REL="PREVIOUS" TITLE="可靠性和预写式日志" HREF="http://school.yunwei.edu/manual/PostgreSQL/wal.html"><LINK REL="NEXT" TITLE="预写式日志(WAL)" HREF="wal-intro.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/wal.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="可靠性和预写式日志" HREF="http://school.yunwei.edu/manual/PostgreSQL/wal.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/wal.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 29. 可靠性和预写式日志</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="预写式日志(WAL)" HREF="wal-intro.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="WAL-RELIABILITY">29.1. 可靠性</A></H1><P>可靠性是任何严肃的数据库系统的重要属性，<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>尽一切可能来保证可靠的操作。
可靠性操作的一个方面是所有已提交的数据都应该存储在一个非易失的区域，这样就不会因为电力失效、
操作系统崩溃、硬件失效(除了非易失区域自身失效之外)等原因导致数据丢失。向计算机的永久存储
(磁盘驱动器或者等效的东西)成功写入数据通常可以满足这个要求。实际上，即使计算机完全失效，
只要磁盘驱动器生存下来，那么它们就可以移动到另外一台类似硬件的计算机上，
而所有已经提交的事务将保持原状。</P><P>周期性地强制数据写入磁盘盘片看上去像一件简单的操作，但实际上不是。
因为磁盘驱动器比内存和 CPU 要慢许多，在计算机的主存和磁盘盘片之间存在多层缓冲。
首先，有操作系统的缓冲区内存，它缓冲常用的磁盘块并且组合对磁盘写入的请求。幸运的是，
所有操作系统都给予应用一个强制从缓冲区写入磁盘的方法，<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
使用了该特性(参阅<A HREF="runtime-config-wal.html#GUC-WAL-SYNC-METHOD">wal_sync_method</A>参数)。</P><P>然后，在磁盘驱动器的控制器上可能还有一个缓冲；特别是在<ACRONYM CLASS="ACRONYM">RAID</ACRONYM>控制卡上更为常见。
这些缓冲区中，有些是<I CLASS="FIRSTTERM">透过式写入</I>，意思是写入动作在到达的同时写入到磁盘上。
其它则是<I CLASS="FIRSTTERM">回写式写入</I>，意思是数据将在稍后写入驱动器。这样的缓冲区是可靠性的危害，
因为磁盘控制器上的内存是易失的，在发生电力失效的情况下会丢失其中的内容。
好一些的控制器卡备有<I CLASS="FIRSTTERM">电池备份单元</I>(<ACRONYM CLASS="ACRONYM">BBU</ACRONYM>s)，
可以在系统电力失效的情况下提供电力。在电力恢复之后，这些数据将会被写入磁盘驱动器。</P><P>最后，大多数磁盘驱动器自身也有缓冲区。有些是透过式的，有些是回写式的。
和磁盘控制器一样，回写式的磁盘缓冲区也存在数据丢失的问题。
消费级别的 IDE 和 SATA 驱动器特别容易包含回写式缓冲，在掉电的情况下很容易丢失数据。
很多固态磁盘(SSD)也有易失的回写式缓冲。</P><P>这些缓存通常可以禁用；然而，这样做的方法会因操作系统和驱动类型而不同。</P><P></P><UL><LI><P>在<SPAN CLASS="PRODUCTNAME">Linux</SPAN>上，IDE和SATA驱动器可以使用<TT CLASS="COMMAND">hdparm -I</TT>查询；
如果在<TT CLASS="LITERAL">Write cache</TT>后面有一个<TT CLASS="LITERAL">*</TT>则写缓存是开启的。<TT CLASS="COMMAND">hdparm -W 0</TT>
可以用来关闭写缓存。SCSI驱动器可以使用<A HREF="http://sg.danny.cz/sg/sdparm.html" TARGET="_top"><SPAN CLASS="APPLICATION">sdparm</SPAN></A>
查询。使用<TT CLASS="COMMAND">sdparm --get=WCE</TT>来检查写缓存是否打开，使用<TT CLASS="COMMAND">sdparm --clear=WCE</TT>
来关闭写缓存。</P></LI><LI><P>在<SPAN CLASS="PRODUCTNAME">FreeBSD</SPAN>上，IDE驱动器可以使用<TT CLASS="COMMAND">atacontrol</TT>查询，
写缓存在<TT CLASS="FILENAME">/boot/loader.conf</TT>里用<TT CLASS="LITERAL">hw.ata.wc=0</TT>来关闭；
SCSI驱动器可以使用<TT CLASS="COMMAND">camcontrol identify</TT>查询，写缓存也同时查询，
并且当可用时使用 <TT CLASS="COMMAND">sdparm</TT>改变状态。</P></LI><LI><P>在<SPAN CLASS="PRODUCTNAME">Solaris</SPAN>上，磁盘写缓存通过<TT CLASS="COMMAND">format -e</TT>来控制。
（Solaris <ACRONYM CLASS="ACRONYM">ZFS</ACRONYM>文件系统对于打开磁盘写缓存是安全的，因为它发行自己的磁盘缓存刷新命令。）</P></LI><LI><P>在<SPAN CLASS="PRODUCTNAME">Windows</SPAN>上，如果<TT CLASS="VARNAME">wal_sync_method</TT>为<TT CLASS="LITERAL">open_datasync</TT>（默认值），
写缓存可以通过取消选中<TT CLASS="LITERAL">My Computer\Open\<TT CLASS="REPLACEABLE"><I>disk drive</I></TT>\Properties\Hardware\Properties\Policies\Enable write caching on the disk</TT>
来禁用。或者，设置<TT CLASS="VARNAME">wal_sync_method</TT>为<TT CLASS="LITERAL">fsync</TT>或<TT CLASS="LITERAL">fsync_writethrough</TT>
来阻止写缓存。&#13;</P></LI><LI><P>在<SPAN CLASS="PRODUCTNAME">Mac OS X</SPAN>上，写缓存可以通过设置<TT CLASS="VARNAME">wal_sync_method</TT>
为<TT CLASS="LITERAL">fsync_writethrough</TT>来阻止。</P></LI></UL><P>最近的SATA驱动器（跟随<ACRONYM CLASS="ACRONYM">ATAPI-6</ACRONYM>或以后的）提供一个驱动器缓存刷新命令(<TT CLASS="COMMAND">FLUSH CACHE EXT</TT>)，
而SCSI驱动器长期以来支持一个类似的命令<TT CLASS="COMMAND">SYNCHRONIZE CACHE</TT>。这些命令不能直接访问<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>，
但是某些文件系统（例如，<ACRONYM CLASS="ACRONYM">ZFS</ACRONYM>，<ACRONYM CLASS="ACRONYM">ext4</ACRONYM>）可以使用它们来刷新数据到启用了回写的驱动器上的盘片上。
不幸的是，这样的文件系统只有在组合电池备份单元(<ACRONYM CLASS="ACRONYM">BBU</ACRONYM>)磁盘驱动器时行为有效。在这样的设置中，
同步命令强制所有数据从驱动器缓存到磁盘，消除BBU的好处。你可以运行<A HREF="pgtestfsync.html"><SPAN CLASS="APPLICATION">pg_test_fsync</SPAN></A>
程序来查看你是否受影响。如果你受到影响，BBU的性能优势可以通过在文件系统中关掉写屏障或重新配置磁盘控制器重新获得，
如果这是一个选项。如果关闭了写屏障，确保电池仍然运行；失效的电池可能导致数据丢失。
希望文件系统和磁盘控制器设计将最终解决这个次优的行为。</P><P>在操作系统向存储硬件发出一个写请求的时候，它没有什么好办法来保证数据真正到达非易失的存储区域。
实际上，确保所有存储部件都保证数据和文件系统元数据的完整性是管理员的责任。
应该避免使用没有电池供电的回写缓冲磁盘控制器。在驱动级别，
如果驱动器不能保证在关闭(掉电)之前写入数据，那么应该关闭回写缓冲。
如果你使用SSD，要知道这些默认不尊重缓存刷新命令。你可以使用
<A HREF="http://brad.livejournal.com/2116715.html" TARGET="_top"><TT CLASS="FILENAME">diskchecker.pl</TT></A>
测试可靠的I/O子系统的行为。</P><P>另外一个数据丢失的风险来自磁盘盘片写操作自身。磁盘盘片会被分割为段，通常每段 512 字节。
每次物理读写都对整个段进行操作。当一个写操作到达磁盘的时候，它可能是512字节的某些整数倍
（<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>通常一次写入8192字节，或者16段），而写入操作可能因为电力失效而随时失败，
意味着某些 512 字节的段写入了，而另一些则没有。为了避免这个问题，<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
在修改磁盘上的实际页面<SPAN CLASS="emphasis"><I CLASS="EMPHASIS">之前</I></SPAN>周期性地把整个页面的影像写入永久WAL存储。这样，
在崩溃恢复的时候，<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>就可以从WAL中恢复部分写入的页面。
如果你有文件系统(比如ZFS)自身能够避免部分页面写入，你可以通过关闭<A HREF="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</A>
参数来关闭页面影像功能。电池备份单元(BBU)磁盘控制器不能阻止部分页面写入，
除非他们保证数据以完整页面（8kB）写入BBU。</P><P><SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>也能阻止某些因为硬件错误或介质失效可能发生在存储驱动器上的数据损坏，
比如读/写垃圾数据。
<P></P></P><UL><LI><P>在WAL文件中的每个单独的记录受CRC-32 (32-bit)校验保护，这样允许我们判断记录内容是否正确。
当我们在崩溃恢复时写入每个WAL记录和检查、归档记录和复制时设置CRC值。</P></LI><LI><P>数据页不是当前校验和的，尽管在WAL记录中的整个页面图像记录将受到保护。
为未来使用数据页校验和特性，数据页有一个16位字段可用。</P></LI><LI><P>内部数据结构例如<TT CLASS="FILENAME">pg_clog</TT>, <TT CLASS="FILENAME">pg_subtrans</TT>,
<TT CLASS="FILENAME">pg_multixact</TT>, <TT CLASS="FILENAME">pg_serial</TT>, <TT CLASS="FILENAME">pg_notify</TT>,
<TT CLASS="FILENAME">pg_stat</TT>, <TT CLASS="FILENAME">pg_snapshots</TT> 不是直接校验和的，
也不是通过全页面写入受到保护的页面。然而，这样的数据结构具有持久性，
WAL记录书面允许最近的改变在崩溃恢复时精确重建并且这些WAL记录正如上述讨论的那样受到保护。</P></LI><LI><P>在<TT CLASS="FILENAME">pg_twophase</TT>中的个人状态文件受到CRC-32保护。</P></LI><LI><P>临时数据文件用于较大的SQL查询，具体化和中间结果不是当前校验和的，
也不会WAL记录被写入修改这些文件。</P></LI></UL><P>
</P><P><SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>不预防矫正内存错误，假设您将使用具有工业标准纠错编码(ECC)
的内存操作或更好的保护。</P></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/wal.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="wal-intro.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">可靠性和预写式日志</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/wal.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">预写式日志(<ACRONYM CLASS="ACRONYM">WAL</ACRONYM>)</TD></TR></TABLE></DIV></BODY></HTML>
