<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>pg_basebackup</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="PostgreSQL 客户端应用程序" HREF="http://school.yunwei.edu/manual/PostgreSQL/reference-client.html"><LINK REL="PREVIOUS" TITLE="ecpg" HREF="app-ecpg.html"><LINK REL="NEXT" TITLE="pg_config" HREF="app-pgconfig.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="REFENTRY">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/ref/pg_basebackup.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="ecpg" HREF="app-ecpg.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/reference-client.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom"></TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="pg_config" HREF="app-pgconfig.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><H1><A NAME="APP-PGBASEBACKUP"></A>pg_basebackup</H1><DIV CLASS="REFNAMEDIV"><A NAME="AEN83791"></A><H2>&#21517;&#31216;</H2>pg_basebackup&nbsp;--&nbsp;做一个<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 集群的基础备份</DIV><DIV CLASS="REFSYNOPSISDIV"><A NAME="AEN83797"></A><H2>&#22823;&#32434;</H2><P><TT CLASS="COMMAND">pg_basebackup</TT> [<TT CLASS="REPLACEABLE"><I>选项</I></TT>...]</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN83802"></A><H2> 描述
</H2><P><SPAN CLASS="APPLICATION">pg_basebackup</SPAN>用来给一个运行的<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
数据库集群进行基础备份。进行时不会影响到连接到数据库的客户端，并且同时可以用于时间点恢复
（参阅<A HREF="continuous-archiving.html">第 24.3 &#33410;</A>）和日志传输或流复制备用服务器的起始点
（参阅<A HREF="warm-standby.html">第 25.2 &#33410;</A>）。</P><P><SPAN CLASS="APPLICATION">pg_basebackup</SPAN>做一个数据库集群文件的二进制拷贝，
同时确保系统自动进出自动备份模式。备份总是使用整个的数据库集群，
不可能只备份单个的数据库或数据库对象。对于单个数据库备份，必须使用如
<A HREF="app-pgdump.html">pg_dump</A>的工具。</P><P>备份时通过一个普通的<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>连接制作的，并且使用复制协议。
该连接必须由超级用户或一个拥有<TT CLASS="LITERAL">REPLICATION</TT>权限的用户完成
（参阅<A HREF="role-attributes.html">第 20.2 &#33410;</A>），并且<TT CLASS="FILENAME">pg_hba.conf</TT>
必须明确允许复制连接。该服务器也必须由<A HREF="runtime-config-replication.html#GUC-MAX-WAL-SENDERS">max_wal_senders</A>配置，
设置足够高的级别，对于备份至少有一个会话可用。</P><P>在同一时刻可能有多个<TT CLASS="COMMAND">pg_basebackup</TT>运行，但是从性能来说最好只采取一个备份，然后复制结果。</P><P><SPAN CLASS="APPLICATION">pg_basebackup</SPAN>不止可以从主机备份还可以从备机备份。要从备机备份，
设置备机以使其可以接受复制连接（也就是，设置<TT CLASS="VARNAME">max_wal_senders</TT> 和
<A HREF="runtime-config-replication.html#GUC-HOT-STANDBY">hot_standby</A>，并且配置<A HREF="auth-pg-hba-conf.html">host-based authentication</A>）。
也需要在主机上启用<A HREF="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</A>。</P><P>请注意，这里有几个从备机在线备份的限制：
<P></P></P><UL><LI><P>备份历史文件不是在数据库集群备份时创建的。</P></LI><LI><P>不保证所有需要备份的WAL文件在备份的最后归档。如果你计划使用备份作为归档恢复，
并希望保证此刻所有需要的文件都可以使用，你需要通过使用<TT CLASS="LITERAL">-x</TT>选项将他们包含到备份中。</P></LI><LI><P>如果备机在在线备份期间被提升为主机，则备份失败。</P></LI><LI><P>所有需要备份的WAL记录必须包含足够的全版书写，这需要你在主机上启用<TT CLASS="VARNAME">full_page_writes</TT>
并且不使用类似<SPAN CLASS="APPLICATION">pg_compresslog</SPAN>这样的工具作为<TT CLASS="VARNAME">archive_command</TT>
从WAL文件中删除全版书写。</P></LI></UL><P>
</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN83840"></A><H2>选项</H2><P>下列的命令行选项控制输出的位置和格式。
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="OPTION">-D <TT CLASS="REPLACEABLE"><I>directory</I></TT></TT><BR><TT CLASS="OPTION">--pgdata=<TT CLASS="REPLACEABLE"><I>directory</I></TT></TT></DT><DD><P>写输出的目录。<SPAN CLASS="APPLICATION">pg_basebackup</SPAN>将创建目录和任何父目录（如果需要）。
该目录可能已经存在，但是如果该目录已经存在并且不为空则是一个错误。</P><P>当备份在tar模式，并且目录以<TT CLASS="LITERAL">-</TT>（破折号）声明，那么tar文件将写入<TT CLASS="LITERAL">stdout</TT>。</P><P>这个选项是必需的。</P></DD><DT><TT CLASS="OPTION">-F <TT CLASS="REPLACEABLE"><I>format</I></TT></TT><BR><TT CLASS="OPTION">--format=<TT CLASS="REPLACEABLE"><I>format</I></TT></TT></DT><DD><P>选择输出格式。<TT CLASS="REPLACEABLE"><I>format</I></TT>可以是下列之一：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="LITERAL">p</TT><BR><TT CLASS="LITERAL">plain</TT></DT><DD><P>将输出写作普通的文件，该文件与当前数据目录和表空间有相同的布局。当集群没有额外的表空间时，
整个数据库将被放入目标目录中。如果集群包含额外的表空间，那么主数据目录将被放入目标目录中，
但是所有其他表空间将被放入与它们在服务器上相同的绝对路径中。</P><P>这是缺省的格式。</P></DD><DT><TT CLASS="LITERAL">t</TT><BR><TT CLASS="LITERAL">tar</TT></DT><DD><P>将输出写作目标目录中的tar文件。主数据目录将被写成一个命名为<TT CLASS="FILENAME">base.tar</TT>
的文件，所有其他表空间将以表空间OID命名。</P><P>如果值<TT CLASS="LITERAL">-</TT>（破折号）被声明为目标目录，那么tar内容将被写成标准输出，
适合于管道如<SPAN CLASS="PRODUCTNAME">gzip</SPAN>。只有集群没有额外的表空间时这才是可能的。</P></DD></DL></DIV><P></P></DD><DT><TT CLASS="OPTION">-R</TT><BR><TT CLASS="OPTION">--write-recovery-conf</TT></DT><DD><P>在输出目录（或使用tar格式时为基础归档文件）中写一个最小的<TT CLASS="FILENAME">recovery.conf</TT>
以减轻设置一个备用服务器。</P></DD><DT><TT CLASS="OPTION">-x</TT><BR><TT CLASS="OPTION">--xlog</TT></DT><DD><P>使用这个选项等同于使用方法<TT CLASS="LITERAL">fetch</TT>的<TT CLASS="LITERAL">-X</TT>。</P></DD><DT><TT CLASS="OPTION">-X <TT CLASS="REPLACEABLE"><I>method</I></TT></TT><BR><TT CLASS="OPTION">--xlog-method=<TT CLASS="REPLACEABLE"><I>method</I></TT></TT></DT><DD><P>在备份中包含所需的事务日志文件（WAL文件）。这将包括所有在备份期间产生的事务日志。
如果声明了这个选项，那么直接在提取出的目录（不需要参考日志归档）中启动一个主进程是可能的。
因此使其成为一个完全独立的备份。</P><P> 支持下列收集事务日志的方法：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="LITERAL">f</TT><BR><TT CLASS="LITERAL">fetch</TT></DT><DD><P>事务日志文件在备份结束时收集。因此，<A HREF="runtime-config-replication.html#GUC-WAL-KEEP-SEGMENTS">wal_keep_segments</A>
参数有必要设置的足够高，使日志在备份结束之前不会被删除。如果日志在要被转移的时候已经转动了，
那么备份将失败并且不能使用。</P></DD><DT><TT CLASS="LITERAL">s</TT><BR><TT CLASS="LITERAL">stream</TT></DT><DD><P>当备份创建时流事务日志。这将在运行备份时打开又一个到服务器的连接并并行启动流事务日志。
因此，它将使用两个<A HREF="runtime-config-replication.html#GUC-MAX-WAL-SENDERS">max_wal_senders</A>参数配置的插槽。
只要客户端可以跟上接收到的事务日志，使用这个方法需要没有额外的事务日志在主机上保存。</P></DD></DL></DIV><P>
</P></DD><DT><TT CLASS="OPTION">-z</TT><BR><TT CLASS="OPTION">--gzip</TT></DT><DD><P>启用tar文件输出的gzip压缩，使用缺省的压缩级别。只有使用tar模式的时候可用压缩。</P></DD><DT><TT CLASS="OPTION">-Z <TT CLASS="REPLACEABLE"><I>level</I></TT></TT><BR><TT CLASS="OPTION">--compress=<TT CLASS="REPLACEABLE"><I>level</I></TT></TT></DT><DD><P>启用tar文件输出的gzip压缩，并声明压缩级别（1到9，9为顶级压缩）。只有使用tar模式的时候可用压缩。</P></DD></DL></DIV><P>
</P><P>下列的命令行选项控制备份的生成和程序的运行。
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="OPTION">-c <TT CLASS="REPLACEABLE"><I>fast|spread</I></TT></TT><BR><TT CLASS="OPTION">--checkpoint=<TT CLASS="REPLACEABLE"><I>fast|spread</I></TT></TT></DT><DD><P>设置检查点模式为fast或spread（缺省）。</P></DD><DT><TT CLASS="OPTION">-l <TT CLASS="REPLACEABLE"><I>label</I></TT></TT><BR><TT CLASS="OPTION">--label=<TT CLASS="REPLACEABLE"><I>label</I></TT></TT></DT><DD><P>为备份设置标签。如果没有声明，将使用<SPAN CLASS="QUOTE">"<TT CLASS="LITERAL">pg_basebackup 基础备份</TT>"</SPAN>的默认值。</P></DD><DT><TT CLASS="OPTION">-P</TT><BR><TT CLASS="OPTION">--progress</TT></DT><DD><P>启用进展报告。启用这个选项将会在备份期间发送一个大概的进展报告。因为数据库可能会在备份期间改变，
所以这只是一个大概并且可能不正好是<TT CLASS="LITERAL">100%</TT>结束。特别是，
当在备份中包含WAL日志时，数据的总量不能提前估计，并且这种情况下一旦它传递的总估计不包含WAL，
那么估计的目标大小还会增加。</P><P>当启用这个选项时，备份将从枚举整个数据库的大小开始，然后返回并发送实际的内容。
这样可能会导致备份时间稍长一些，尤其是在发送第一个数据之前的时间稍长。</P></DD><DT><TT CLASS="OPTION">-v</TT><BR><TT CLASS="OPTION">--verbose</TT></DT><DD><P>启用冗长模式。将在启动和关闭时输出一些额外的步骤，如果也启用了进度报告，
则也显示当前正在被处理的准确的文件名。</P></DD></DL></DIV><P>
</P><P> 下列的命令行选项控制数据库连接参数。
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="OPTION">-d <TT CLASS="REPLACEABLE"><I>connstr</I></TT></TT><BR><TT CLASS="OPTION">--dbname=<TT CLASS="REPLACEABLE"><I>connstr</I></TT></TT></DT><DD><P>声明用来连接到服务器的参数，作为一个连接字符串。参阅<A HREF="libpq-connect.html#LIBPQ-CONNSTRING">第 31.1.1 &#33410;</A>获取更多信息。</P><P>该选项被称为<TT CLASS="LITERAL">--dbname</TT>是为了与其他客户端应用的一致性，但是因为
<SPAN CLASS="APPLICATION">pg_basebackup</SPAN>不连接到集群中的任何特别的数据库，
所以将忽略连接字符串中的数据库名字。</P></DD><DT><TT CLASS="OPTION">-h <TT CLASS="REPLACEABLE"><I>host</I></TT></TT><BR><TT CLASS="OPTION">--host=<TT CLASS="REPLACEABLE"><I>host</I></TT></TT></DT><DD><P>声明服务器正在运行的机器的主机名。如果这个值以一个斜线开始，则被用作Unix域套接字的目录。
默认从<TT CLASS="ENVAR">PGHOST</TT>环境变量中获取（如果设置了），否则尝试一个Unix域套接字连接。</P></DD><DT><TT CLASS="OPTION">-p <TT CLASS="REPLACEABLE"><I>port</I></TT></TT><BR><TT CLASS="OPTION">--port=<TT CLASS="REPLACEABLE"><I>port</I></TT></TT></DT><DD><P>声明服务器正在监听的TCP端口或本地Unix域套接字文件扩展。缺省是<TT CLASS="ENVAR">PGPORT</TT>
环境变量（如果设置了），否则是内编译的缺省。</P></DD><DT><TT CLASS="OPTION">-s <TT CLASS="REPLACEABLE"><I>interval</I></TT></TT><BR><TT CLASS="OPTION">--status-interval=<TT CLASS="REPLACEABLE"><I>interval</I></TT></TT></DT><DD><P>声明状态数据包发送回服务器的秒数。这允许对服务器进程的更简单的监视。为了避免连接超时，
零值完全禁用定期状态更新，尽管服务器需要时仍然发送一个更新。缺省值是10秒。</P></DD><DT><TT CLASS="OPTION">-U <TT CLASS="REPLACEABLE"><I>username</I></TT></TT><BR><TT CLASS="OPTION">--username=<TT CLASS="REPLACEABLE"><I>username</I></TT></TT></DT><DD><P>连接的用户名。</P></DD><DT><TT CLASS="OPTION">-w</TT><BR><TT CLASS="OPTION">--no-password</TT></DT><DD><P>从不发出密码提示问题。如果服务器要求密码认证并且密码不可用于其他意思如
<TT CLASS="FILENAME">.pgpass</TT>文件，则连接尝试将会失败。
该选项在批量工作和不存在用户输入密码的脚本中很有帮助。</P></DD><DT><TT CLASS="OPTION">-W</TT><BR><TT CLASS="OPTION">--password</TT></DT><DD><P>强制<SPAN CLASS="APPLICATION">pg_basebackup</SPAN>在连接到数据库之前提示一个密码。</P><P>这个选项从来不是至关重要的，因为如果服务器需求密码认证，则<SPAN CLASS="APPLICATION">pg_basebackup</SPAN>
自动提示一个密码。不过，<SPAN CLASS="APPLICATION">pg_basebackup</SPAN>
将在找出服务器想要一个密码上浪费一个连接尝试。在某些情况下，值得输入<TT CLASS="OPTION">-W</TT>
以避免额外的连接尝试。</P></DD></DL></DIV><P>
</P><P>
其他选项也可用：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="OPTION">-V</TT><BR><TT CLASS="OPTION">--version</TT></DT><DD><P>打印<SPAN CLASS="APPLICATION">pg_basebackup</SPAN>版本然后退出。</P></DD><DT><TT CLASS="OPTION">-?</TT><BR><TT CLASS="OPTION">--help</TT></DT><DD><P>显示关于<SPAN CLASS="APPLICATION">pg_basebackup</SPAN>命令行参数的帮助然后退出。</P></DD></DL></DIV><P>
</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN84077"></A><H2>环境变量</H2><P>这个工具，类似大多数其他<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>实用工具，
也使用由<SPAN CLASS="APPLICATION">libpq</SPAN>支持的环境变量（参阅<A HREF="libpq-envars.html">第 31.14 &#33410;</A>）。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN84083"></A><H2>注意</H2><P>备份将包含数据目录和表空间中的所有文件，包括配置文件和任何第三方放置在目录中的额外文件。
数据目录中只允许普通的文件和目录，不允许符号链接或特殊设备文件。</P><P>当恢复一个备份时，<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>管理表空间的方式，
所有额外表空间的路径必须完全相同。不过，主数据目录可以重新定位任意位置。</P><P><SPAN CLASS="APPLICATION">pg_basebackup</SPAN>可以作用于相同版本或更老版本的服务器（最低9.1），
不过，WAL流模式（-X流）只能是服务器版本9.3。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN84090"></A><H2>例子</H2><P>在<TT CLASS="LITERAL">mydbserver</TT>创建一个服务器的基础备份，并存储到本地目录
<TT CLASS="FILENAME">/usr/local/pgsql/data</TT>中：
</P><PRE CLASS="SCREEN"><SAMP
CLASS="PROMPT"
>$</SAMP
> <KBD
CLASS="USERINPUT"
>pg_basebackup -h mydbserver -D /usr/local/pgsql/data</KBD
></PRE><P></P><P>创建一个本地服务器的备份，用一个为每个表空间压缩的tar文件，并存储到目录<TT CLASS="FILENAME">backup</TT>里，
运行时显示进度报告：
</P><PRE CLASS="SCREEN"><SAMP
CLASS="PROMPT"
>$</SAMP
> <KBD
CLASS="USERINPUT"
>pg_basebackup -D backup -Ft -z -P</KBD
></PRE><P></P><P>创建一个单表空间本地数据库的备份并使用<SPAN CLASS="PRODUCTNAME">bzip2</SPAN>压缩：
</P><PRE CLASS="SCREEN"><SAMP
CLASS="PROMPT"
>$</SAMP
> <KBD
CLASS="USERINPUT"
>pg_basebackup -D - -Ft | bzip2 &gt; backup.tar.bz2</KBD
></PRE><P>
如果数据库中有多个表空间那么这个命令将会失败。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN84108"></A><H2>又见</H2><A HREF="app-pgdump.html">pg_dump</A></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="app-ecpg.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="app-pgconfig.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><SPAN CLASS="APPLICATION">ecpg</SPAN></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/reference-client.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">pg_config</TD></TR></TABLE></DIV></BODY></HTML>
