<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>pg_dumpall</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="PostgreSQL 客户端应用程序" HREF="http://school.yunwei.edu/manual/PostgreSQL/reference-client.html"><LINK REL="PREVIOUS" TITLE="pg_dump" HREF="app-pgdump.html"><LINK REL="NEXT" TITLE="pg_isready" HREF="app-pg-isready.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="REFENTRY">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/ref/pg_dumpall.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="pg_dump" HREF="app-pgdump.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/reference-client.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom"></TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="pg_isready" HREF="app-pg-isready.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><H1><A NAME="APP-PG-DUMPALL"></A><SPAN CLASS="APPLICATION">pg_dumpall</SPAN></H1><DIV CLASS="REFNAMEDIV"><A NAME="AEN85050"></A><H2>&#21517;&#31216;</H2>pg_dumpall&nbsp;--&nbsp;将一个<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>数据库集群转储到一个脚本文件中</DIV><DIV CLASS="REFSYNOPSISDIV"><A NAME="AEN85056"></A><H2>&#22823;&#32434;</H2><P><TT CLASS="COMMAND">pg_dumpall</TT> [<TT CLASS="REPLACEABLE"><I>connection-option</I></TT>...] [<TT CLASS="REPLACEABLE"><I>option</I></TT>...]</P></DIV><DIV CLASS="REFSECT1"><A NAME="APP-PG-DUMPALL-DESCRIPTION"></A><H2>描述</H2><P><SPAN CLASS="APPLICATION">pg_dumpall</SPAN>可以转储一个数据库集群里的所有数据库到一个脚本文件。
该脚本文件包含可以用于作为<A HREF="app-psql.html"><SPAN CLASS="APPLICATION">psql</SPAN></A>输入的<ACRONYM CLASS="ACRONYM">SQL</ACRONYM>命令，
从而恢复数据库。它通过对数据库集群里的每个数据库调用<A HREF="app-pgdump.html">pg_dump</A>
实现这个功能。<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>还转储出所有数据库公用的全局对象。
而<SPAN CLASS="APPLICATION">pg_dump</SPAN>并不保存这些对象。
这些信息包括数据库用户和组、表空间，以及性能如适用于整个数据库的访问权限。</P><P>因为<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>从所有数据库中读取表，
所以你很可能需要以数据库超级用户的身份连接，这样才能生成完整的转储。同样，
你也需要超级用户的权限执行保存下来的脚本，这些才能增加用户和组，以及创建数据库。</P><P>SQL 脚本将写出到标准输出。使用[-f|file]选项或 shell 操作符把它重定向到文件。</P><P><SPAN CLASS="APPLICATION">pg_dumpall</SPAN>需要和<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
服务器连接多次(每个数据库一次)。如果你使用口令认证，可能每次都会询问口令。
这种情况下写一个<TT CLASS="FILENAME">~/.pgpass</TT>可能会比较方便。
参阅<A HREF="libpq-pgpass.html">第 31.15 &#33410;</A>获取更多信息。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN85080"></A><H2>选项</H2><P> 下列命令行参数用于控制输出内容和格式：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="OPTION">-a</TT><BR><TT CLASS="OPTION">--data-only</TT></DT><DD><P>只转储数据，不转储模式(数据定义)。</P></DD><DT><TT CLASS="OPTION">-c</TT><BR><TT CLASS="OPTION">--clean</TT></DT><DD><P>在转储结果中包含那些重建之前清理(drop)数据库对象的 SQL 命令。
对规则和表空间的<TT CLASS="COMMAND">DROP</TT>也会添加进来。</P></DD><DT><TT CLASS="OPTION">-f <TT CLASS="REPLACEABLE"><I>filename</I></TT></TT><BR><TT CLASS="OPTION">--file=<TT CLASS="REPLACEABLE"><I>filename</I></TT></TT></DT><DD><P>发送输出到指定的文件。如果省略了这个选项，就使用标准输出。</P></DD><DT><TT CLASS="OPTION">-g</TT><BR><TT CLASS="OPTION">--globals-only</TT></DT><DD><P>只转储全局对象(角色和表空间)，而不转储数据库。</P></DD><DT><TT CLASS="OPTION">-i</TT><BR><TT CLASS="OPTION">--ignore-version</TT></DT><DD><P>一个现在已经忽略了的废弃选项。</P></DD><DT><TT CLASS="OPTION">-o</TT><BR><TT CLASS="OPTION">--oids</TT></DT><DD><P>作为数据的一部分，为每个表都输出对象标识(<ACRONYM CLASS="ACRONYM">OID</ACRONYM>)。
如果你的应用需要<ACRONYM CLASS="ACRONYM">OID</ACRONYM>字段的话(比如在外键约束中用到)，那么使用这个选项。
否则，不应该使用这个选项。</P></DD><DT><TT CLASS="OPTION">-O</TT><BR><TT CLASS="OPTION">--no-owner</TT></DT><DD><P>不把对象的所有权设置为对应源数据库。<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>默认发出
<TT CLASS="COMMAND">ALTER OWNER</TT>或<TT CLASS="COMMAND">SET SESSION AUTHORIZATION</TT>
语句以设置创建的数据库对象的所有权。如果这些脚本将来没有被超级用户
(或者拥有脚本中全部对象的用户)运行的话将会失败。<TT CLASS="OPTION">-O</TT>
选项就是为了让该脚本可以被任何用户恢复并且将脚本中对象的所有权赋予该选项指定的用户。</P></DD><DT><TT CLASS="OPTION">-r</TT><BR><TT CLASS="OPTION">--roles-only</TT></DT><DD><P>只转储角色，不转储数据库或表空间。</P></DD><DT><TT CLASS="OPTION">-s</TT><BR><TT CLASS="OPTION">--schema-only</TT></DT><DD><P>只输出对象定义(模式)，不输出数据。</P></DD><DT><TT CLASS="OPTION">-S <TT CLASS="REPLACEABLE"><I>username</I></TT></TT><BR><TT CLASS="OPTION">--superuser=<TT CLASS="REPLACEABLE"><I>username</I></TT></TT></DT><DD><P>指定关闭触发器时需要用到的超级用户名。它只有使用了<TT CLASS="OPTION">--disable-triggers</TT>
的时候才有影响。一般情况下最好不要输入这个参数，而是用超级用户启动生成的脚本。</P></DD><DT><TT CLASS="OPTION">-t</TT><BR><TT CLASS="OPTION">--tablespaces-only</TT></DT><DD><P>只转储表空间，不转储数据库或角色。</P></DD><DT><TT CLASS="OPTION">-v</TT><BR><TT CLASS="OPTION">--verbose</TT></DT><DD><P>指定冗余模式。这样将令<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>
输出转储文件的启停时间和进度信息到标准错误上。它将同时启用<SPAN CLASS="APPLICATION">pg_dump</SPAN>的冗余输出。</P></DD><DT><TT CLASS="OPTION">-V</TT><BR><TT CLASS="OPTION">--version</TT></DT><DD><P>打印<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>的版本然后退出。</P></DD><DT><TT CLASS="OPTION">-x</TT><BR><TT CLASS="OPTION">--no-privileges</TT><BR><TT CLASS="OPTION">--no-acl</TT></DT><DD><P>禁止转储访问权限(grant/revoke 命令)。</P></DD><DT><TT CLASS="OPTION">--binary-upgrade</TT></DT><DD><P>这个选项用于本地升级工具。不建议也不支持用于其他目的。
该选项的性能可能会在将来的版本中改变。</P></DD><DT><TT CLASS="OPTION">--column-inserts</TT><BR><TT CLASS="OPTION">--attribute-inserts</TT></DT><DD><P>把数据转储为带有明确字段名的<TT CLASS="COMMAND">INSERT</TT>命令(<TT CLASS="LITERAL">INSERT INTO
<TT CLASS="REPLACEABLE"><I>table</I></TT> (<TT CLASS="REPLACEABLE"><I>column</I></TT>, ...) VALUES
...</TT>)。这样会导致恢复非常缓慢，它主要用于制作那种可以用于其它非
<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>数据库的转储。</P></DD><DT><TT CLASS="OPTION">--disable-dollar-quoting</TT></DT><DD><P>这个选项关闭使用美元符界定函数体。强制它们用 SQL 标准的字符串语法的引号包围。</P></DD><DT><TT CLASS="OPTION">--disable-triggers</TT></DT><DD><P>这个选项只是和创建仅有数据的转储相关。它告诉<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>
包含在恢复数据时临时关闭目标表上触发器的命令。如果在表上有参照完整性检查或者其它触发器，
而恢复数据的时候不想重载他们，那么就应该使用这个选项。</P><P>目前，为<TT CLASS="OPTION">--disable-triggers</TT>发出的命令必须以超级用户来执行。因此，
你应该同时用<TT CLASS="OPTION">-S</TT>声明一个超级用户名，
或者最好是用一个超级用户的身份来启动这个生成的脚本。</P></DD><DT><TT CLASS="OPTION">--inserts</TT></DT><DD><P>把数据转储为<TT CLASS="COMMAND">INSERT</TT>命令(而不是<TT CLASS="COMMAND">COPY</TT>)。
这样将令恢复过程非常缓慢，这个选项主要用于制作那种可以用于其它非
<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>数据库的转储。请注意，
如果你重新排列了字段顺序，那么恢复可能会完全失败。<TT CLASS="OPTION">--column-inserts</TT>
更安全，但是也更慢。</P></DD><DT><TT CLASS="OPTION">--lock-wait-timeout=<TT CLASS="REPLACEABLE"><I>timeout</I></TT></TT></DT><DD><P>在转储开始的时候不要等待请求一个共享表锁。相反，如果无法在指定的
<TT CLASS="REPLACEABLE"><I>timeout</I></TT>内锁住表则失败。
timeout可以用任意<TT CLASS="COMMAND">SET statement_timeout</TT>接受的格式声明。
允许的值依赖于你转储的服务器版本，但是自7.3以来，所有的版本都接受毫秒的整数值。
当从7.3以前的版本服务器中转储时，省略该选项。</P></DD><DT><TT CLASS="OPTION">--no-security-labels</TT></DT><DD><P>不转储安全标签。</P></DD><DT><TT CLASS="OPTION">--no-tablespaces</TT></DT><DD><P>不要输出为对象创建表空间或选择表空间的命令。有了该选项，
所有对象在转储期间都将在缺省的表空间中创建。</P></DD><DT><TT CLASS="OPTION">--no-unlogged-table-data</TT></DT><DD><P>不要转储未记录表的内容。该选项对于表定义（模式）是否转储没有影响；它只阻止转储表的数据。</P></DD><DT><TT CLASS="OPTION">--quote-all-identifiers</TT></DT><DD><P>强制给所有标识符加上引号。这在转储一个数据库到一个可能引入了额外关键字的新版本中时可能是有用的。</P></DD><DT><TT CLASS="OPTION">--use-set-session-authorization</TT></DT><DD><P>输出符合 SQL 标准的<TT CLASS="COMMAND">SET SESSION AUTHORIZATION</TT>命令而不是<TT CLASS="COMMAND">ALTER OWNER</TT>
命令来确定对象所有权。这样令转储更加符合标准，但是如果转储文件中的对象的历史有些问题，
那么可能不能正确恢复。</P></DD><DT><TT CLASS="OPTION">-?</TT><BR><TT CLASS="OPTION">--help</TT></DT><DD><P>显示关于<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>命令行参数的帮助然后退出。</P></DD></DL></DIV><P>
</P><P> 下面的命令行参数控制数据库的连接参数。
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="OPTION">-d <TT CLASS="REPLACEABLE"><I>connstr</I></TT></TT><BR><TT CLASS="OPTION">--dbname=<TT CLASS="REPLACEABLE"><I>connstr</I></TT></TT></DT><DD><P>指定用于连接到服务器的参数，作为连接字符串。参阅<A HREF="libpq-connect.html#LIBPQ-CONNSTRING">第 31.1.1 &#33410;</A>获取更多信息。</P><P>为了与其他客户端应用保持一致，这个选项被叫做<TT CLASS="LITERAL">--dbname</TT>，但是因为
<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>需要连接到多个数据库，所以连接字符串中的数据库名将会省略。
使用<TT CLASS="LITERAL">-l</TT>选项指定用于转储全局对象的数据库名和找出应该转储的其他数据库。</P></DD><DT><TT CLASS="OPTION">-h <TT CLASS="REPLACEABLE"><I>host</I></TT></TT><BR><TT CLASS="OPTION">--host=<TT CLASS="REPLACEABLE"><I>host</I></TT></TT></DT><DD><P>指定运行服务器的主机名。如果数值以斜杠开头，则被用作到 Unix 域套接字的路径。
缺省从<TT CLASS="ENVAR">PGHOST</TT>环境变量中获取(如果设置了的话)，否则，尝试一个 Unix 域套接字连接。</P></DD><DT><TT CLASS="OPTION">-l <TT CLASS="REPLACEABLE"><I>dbname</I></TT></TT><BR><TT CLASS="OPTION">--database=<TT CLASS="REPLACEABLE"><I>dbname</I></TT></TT></DT><DD><P>指定用于转储全局对象的数据库名和找出应该转储的其他数据库。如果没有声明，
将使用<TT CLASS="LITERAL">postgres</TT>数据库，如果<TT CLASS="LITERAL">postgres</TT>数据库不存在，
则使用<TT CLASS="LITERAL">template1</TT>。</P></DD><DT><TT CLASS="OPTION">-p <TT CLASS="REPLACEABLE"><I>port</I></TT></TT><BR><TT CLASS="OPTION">--port=<TT CLASS="REPLACEABLE"><I>port</I></TT></TT></DT><DD><P>指定服务器正在侦听的 TCP 端口或本地 Unix 域套接字文件的扩展(描述符)。
缺省使用<TT CLASS="ENVAR">PGPORT</TT>环境变量(如果设置了的话)，否则，编译时的缺省值。</P></DD><DT><TT CLASS="OPTION">-U <TT CLASS="REPLACEABLE"><I>username</I></TT></TT><BR><TT CLASS="OPTION">--username=<TT CLASS="REPLACEABLE"><I>username</I></TT></TT></DT><DD><P>连接的用户名。</P></DD><DT><TT CLASS="OPTION">-w</TT><BR><TT CLASS="OPTION">--no-password</TT></DT><DD><P>从不发出密码提示问题。如果服务器要求密码认证并且密码不可用于其他意思如
<TT CLASS="FILENAME">.pgpass</TT>文件，则连接尝试将会失败。
该选项在批量工作和不存在用户输入密码的脚本中很有帮助。</P></DD><DT><TT CLASS="OPTION">-W</TT><BR><TT CLASS="OPTION">--password</TT></DT><DD><P>强制<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>在连接到数据库之前提示一个密码。</P><P>这个选项从来不是至关重要的，因为如果服务器需求密码认证，则<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>
自动提示一个密码。不过，<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>
将在找出服务器想要一个密码上浪费一个连接尝试。在某些情况下，值得输入<TT CLASS="OPTION">-W</TT>
以避免额外的连接尝试。</P><P>请注意，密码提示将在每个要转储的数据库上发生。通常，建立一个<TT CLASS="FILENAME">~/.pgpass</TT>
文件比依赖于手动输入密码好的多。</P></DD><DT><TT CLASS="OPTION">--role=<TT CLASS="REPLACEABLE"><I>rolename</I></TT></TT></DT><DD><P>指定创建转储的角色名。这个选项导致连接到数据库之后<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>
发出一个<TT CLASS="COMMAND">SET ROLE</TT> <TT CLASS="REPLACEABLE"><I>rolename</I></TT>命令。
当认证的用户（通过<TT CLASS="OPTION">-U</TT>指定）缺乏<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>所需的权限时是很有用的，
可以转变成有所需权限的角色。一些安装有反对作为超级用户直接登录的政策，
使用这个选项允许转储不违反该政策。</P></DD></DL></DIV><P>
</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN85372"></A><H2>环境变量</H2><P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="ENVAR">PGHOST</TT><BR><TT CLASS="ENVAR">PGOPTIONS</TT><BR><TT CLASS="ENVAR">PGPORT</TT><BR><TT CLASS="ENVAR">PGUSER</TT></DT><DD><P>缺省连接参数。</P></DD></DL></DIV><P>这个功用，类似大多数其他<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>实用工具，
也使用由<SPAN CLASS="APPLICATION">libpq</SPAN>支持的环境变量（参阅<A HREF="libpq-envars.html">第 31.14 &#33410;</A>）。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN85390"></A><H2>注意</H2><P>因为<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>在内部调用<SPAN CLASS="APPLICATION">pg_dump</SPAN>，
所以，一些诊断信息可以参考<SPAN CLASS="APPLICATION">pg_dump</SPAN>。</P><P>恢复完之后，建议在每个已恢复的对象上运行<TT CLASS="COMMAND">ANALYZE</TT>。
这样优化器就可以得到有用的统计。你也可以用<TT CLASS="COMMAND">vacuumdb -a -z</TT>清理所有数据库。</P><P><SPAN CLASS="APPLICATION">pg_dumpall</SPAN>要求所有需要的表空间目录在进行恢复之前就必须存在，
否则在非标准位置创建数据库将会失败。</P></DIV><DIV CLASS="REFSECT1"><A NAME="APP-PG-DUMPALL-EX"></A><H2>例子</H2><P>转储所有数据库：
</P><PRE CLASS="SCREEN"><SAMP
CLASS="PROMPT"
>$</SAMP
> <KBD
CLASS="USERINPUT"
>pg_dumpall &gt; db.out</KBD
></PRE><P></P><P>从该文件中恢复数据库：
</P><PRE CLASS="SCREEN"><SAMP
CLASS="PROMPT"
>$</SAMP
> <KBD
CLASS="USERINPUT"
>psql -f db.out postgres</KBD
></PRE><P>
执行这个命令的时候连接到哪个数据库无关紧要，因为<SPAN CLASS="APPLICATION">pg_dumpall</SPAN>
创建的脚本将会包含恰当的创建和连接数据库的命令。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN85412"></A><H2>又见</H2><P>看看<A HREF="app-pgdump.html">pg_dump</A>获取可能的错误条件的详细信息。</P></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="app-pgdump.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="app-pg-isready.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">pg_dump</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/reference-client.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><SPAN CLASS="APPLICATION">pg_isready</SPAN></TD></TR></TABLE></DIV></BODY></HTML>
