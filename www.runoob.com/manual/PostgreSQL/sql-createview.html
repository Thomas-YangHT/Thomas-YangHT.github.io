<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>CREATE VIEW</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="SQL 命令" HREF="http://school.yunwei.edu/manual/PostgreSQL/sql-commands.html"><LINK REL="PREVIOUS" TITLE="CREATE USER MAPPING" HREF="sql-createusermapping.html"><LINK REL="NEXT" TITLE="DEALLOCATE" HREF="sql-deallocate.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="REFENTRY">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/ref/create_view.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="CREATE USER MAPPING" HREF="sql-createusermapping.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/sql-commands.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom"></TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="DEALLOCATE" HREF="sql-deallocate.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><H1><A NAME="SQL-CREATEVIEW"></A>CREATE VIEW</H1><DIV CLASS="REFNAMEDIV"><A NAME="AEN74461"></A><H2>&#21517;&#31216;</H2>CREATE VIEW&nbsp;--&nbsp;定义一个新视图</DIV><DIV CLASS="REFSYNOPSISDIV"><A NAME="AEN74466"></A><H2>&#22823;&#32434;</H2><PRE CLASS="SYNOPSIS">CREATE [ OR REPLACE ] [ TEMP | TEMPORARY ] [ RECURSIVE ] VIEW <TT
CLASS="REPLACEABLE"
><I
>name</I
></TT
> [ ( <TT
CLASS="REPLACEABLE"
><I
>column_name</I
></TT
> [, ...] ) ]
    [ WITH ( <TT
CLASS="REPLACEABLE"
><I
>view_option_name</I
></TT
> [= <TT
CLASS="REPLACEABLE"
><I
>view_option_value</I
></TT
>] [, ... ] ) ]
    AS <TT
CLASS="REPLACEABLE"
><I
>query</I
></TT
></PRE></DIV><DIV CLASS="REFSECT1"><A NAME="AEN74473"></A><H2>描述</H2><P><TT CLASS="COMMAND">CREATE VIEW</TT>定义一个查询的视图。
这个视图不是物理上实际存在的，并且在该视图每次被引用的时候都会运行一次查询。</P><P><TT CLASS="COMMAND">CREATE OR REPLACE VIEW</TT>是类似的，不过如果一个同名的视图已经存在，
那么将替换它。新查询必须生成与现有视图查询生成的字段相同的字段（也就是，
相同的字段名字，相同的顺序和相同的数据类型），但是可能添加额外的字段到列表的结尾。
该计算导致输出字段可能完全不同。</P><P>如果给出了一个模式名(比如<TT CLASS="LITERAL">CREATE VIEW myschema.myview ...</TT>)，
那么该视图将在指定的模式中创建，否则将在当前模式中创建。
临时视图存在于一个特殊的模式里，所以创建临时视图的时候，不能给出模式名。
新视图名字必需和同一模式中任何其它视图、表、序列、索引或外部表的名字不同。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN74481"></A><H2>参数</H2><P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="LITERAL">TEMPORARY</TT> 或 <TT CLASS="LITERAL">TEMP</TT></DT><DD><P>如果声明了这个子句，那么视图就以临时视图的方式创建。
临时视图在当前会话结束的时候将被自动删除。只要存在临时视图，
已有的同名永久关系表将对当前会话不可见，除非用带模式修饰的名字引用它们。</P><P>如果视图引用的任何基础表是临时的，那么视图将被创建为临时的
(不管是否声明了<TT CLASS="LITERAL">TEMPORARY</TT>)。</P></DD><DT><TT CLASS="LITERAL">RECURSIVE</TT></DT><DD><P>创建一个递归的视图。语法
</P><PRE CLASS="SYNOPSIS">CREATE RECURSIVE VIEW <TT
CLASS="REPLACEABLE"
><I
>name</I
></TT
> (<TT
CLASS="REPLACEABLE"
><I
>columns</I
></TT
>) AS SELECT <TT
CLASS="REPLACEABLE"
><I
>...</I
></TT
>;</PRE><P>
等同于
</P><PRE CLASS="SYNOPSIS">CREATE VIEW <TT
CLASS="REPLACEABLE"
><I
>name</I
></TT
> AS WITH RECURSIVE <TT
CLASS="REPLACEABLE"
><I
>name</I
></TT
> (<TT
CLASS="REPLACEABLE"
><I
>columns</I
></TT
>) AS (SELECT <TT
CLASS="REPLACEABLE"
><I
>...</I
></TT
>) SELECT <TT
CLASS="REPLACEABLE"
><I
>columns</I
></TT
> FROM <TT
CLASS="REPLACEABLE"
><I
>name</I
></TT
>;</PRE><P>
必须为一个递归的视图指定一个视图字段列表。</P></DD><DT><TT CLASS="REPLACEABLE"><I>name</I></TT></DT><DD><P>所要创建的视图名称(可以有模式修饰)。</P></DD><DT><TT CLASS="REPLACEABLE"><I>column_name</I></TT></DT><DD><P>一个可选的名字列表，用作视图的字段名。如果没有给出，字段名取自查询。</P></DD><DT><TT CLASS="LITERAL">WITH ( <TT CLASS="REPLACEABLE"><I>view_option_name</I></TT> [= <TT CLASS="REPLACEABLE"><I>view_option_value</I></TT>] [, ... ] )</TT></DT><DD><P>该子句为视图指定选项参数；目前，唯一支持的参数名是<TT CLASS="LITERAL">security_barrier</TT>，
当视图打算提供行级安全时，应该启用该参数。参阅<A HREF="rules-privileges.html">第 38.5 &#33410;</A>
获取全部细节。</P></DD><DT><TT CLASS="REPLACEABLE"><I>query</I></TT></DT><DD><P>一个将为视图提供行和列的<A HREF="sql-select.html">SELECT</A>
或<A HREF="sql-values.html">VALUES</A>语句。</P></DD></DL></DIV></DIV><DIV CLASS="REFSECT1"><A NAME="AEN74534"></A><H2>注意</H2><P>使用<A HREF="sql-dropview.html">DROP VIEW</A>语句删除视图。</P><P>请注意视图字段的名字和类型不一定是你们期望的那样。比如，
</P><PRE CLASS="PROGRAMLISTING">CREATE VIEW vista AS SELECT 'Hello World';</PRE><P>
在两个方面很糟糕：字段名缺省是<TT CLASS="LITERAL">?column?</TT>
并且字段的数据类型缺省是<TT CLASS="TYPE">unknown</TT>。
如果你想视图的结果是一个字符串文本，那么请像下面这样使用：
</P><PRE CLASS="PROGRAMLISTING">CREATE VIEW vista AS SELECT text 'Hello World' AS hello;</PRE><P></P><P>对视图引用的表的访问的权限由视图的所有者决定。在一些情况下，
这可用于提供安全但是限制访问底层表。不过，不是所有视图对于篡改都是安全的；
参阅<A HREF="rules-privileges.html">第 38.5 &#33410;</A>获取细节。
在视图里被调用的函数，被当作直接从使用视图的查询里调用它们看待。因此，
视图的用户必须有调用视图使用的所有函数的权限。</P><P>当<TT CLASS="COMMAND">CREATE OR REPLACE VIEW</TT>用在一个现有的视图上时，
只改变了视图定义的SELECT规则。其他视图属性，包括所有权、权限和非SELECT规则，
保持不变。要替换视图，你必须拥有该视图（包括成为拥有者角色的一员）。</P><DIV CLASS="REFSECT2"><A NAME="SQL-CREATEVIEW-UPDATABLE-VIEWS"></A><H3>可更新的视图</H3><P>简单的视图是自动可更新的：系统允许<TT CLASS="COMMAND">INSERT</TT>、<TT CLASS="COMMAND">UPDATE</TT>
和<TT CLASS="COMMAND">DELETE</TT>语句，和在常规表上一样的方式，被用在视图上。
如果视图满足所有下列的条件，那么就是自动可更新的：
<P></P></P><UL><LI><P>视图在它的<TT CLASS="LITERAL">FROM</TT>列表中必须只有一个条目，
该条目必须是一个表或其他可更新视图。</P></LI><LI><P>视图定义必须没有在顶级包含<TT CLASS="LITERAL">WITH</TT>、<TT CLASS="LITERAL">DISTINCT</TT>、<TT CLASS="LITERAL">GROUP BY</TT>、
<TT CLASS="LITERAL">HAVING</TT>、<TT CLASS="LITERAL">LIMIT</TT>或<TT CLASS="LITERAL">OFFSET</TT>子句。</P></LI><LI><P>视图定义必须没有在顶级包含集合运算（<TT CLASS="LITERAL">UNION</TT>、<TT CLASS="LITERAL">INTERSECT</TT>
或<TT CLASS="LITERAL">EXCEPT</TT>）。</P></LI><LI><P>视图的选择列表中的所有字段必须简单的引用底层关系的字段。
它们不能是表达式、字面值或函数。也不能引用系统字段。</P></LI><LI><P>在视图的选择列表中，底层关系的字段出现不能超过一次。</P></LI><LI><P>视图必须没有<TT CLASS="LITERAL">security_barrier</TT>属性。</P></LI></UL><P>
</P><P>如果视图是自动可更新的，那么系统将转换视图上的任意<TT CLASS="COMMAND">INSERT</TT>、
<TT CLASS="COMMAND">UPDATE</TT>或<TT CLASS="COMMAND">DELETE</TT>语句为相应的底层基本关系上的语句。</P><P>如果一个自动可更新的视图包含一个<TT CLASS="LITERAL">WHERE</TT>条件，
那么该条件约束基本关系的哪些行可以被视图上的<TT CLASS="COMMAND">UPDATE</TT>
和<TT CLASS="COMMAND">DELETE</TT>语句修改。不过，允许<TT CLASS="COMMAND">UPDATE</TT>
更改一个行，使得它不再满足<TT CLASS="LITERAL">WHERE</TT>条件，并且因此不再通过视图可见。
相似的，<TT CLASS="COMMAND">INSERT</TT>命令也可以插入不满足<TT CLASS="LITERAL">WHERE</TT>
条件的基本关系行，并且因此对这个视图不可见。</P><P>不满足所有这些条件的更复杂的视图缺省是只读的：系统将不允许在该视图上插入、
更新或删除。可以通过在该视图上创建<TT CLASS="LITERAL">INSTEAD OF</TT>触发器获得可更新视图的效果，
该触发器必须转换在该视图上的尝试插入等为其他表上的适当动作。更多信息请参见
<A HREF="sql-createtrigger.html">CREATE TRIGGER</A>。还有一种可能性是创建规则
（参阅<A HREF="sql-createrule.html">CREATE RULE</A>），但是实际上触发器更容易理解和正确使用。</P><P>请注意，用户在视图上执行插入、更新或删除必须在该视图上有相应的插入、
更新或删除的权限。此外，视图的所有者必须在底层基础关系上有相关的权限，
但是执行更新的用户不需要在底层基础关系上的任何权限
（参阅<A HREF="rules-privileges.html">第 38.5 &#33410;</A>）。</P></DIV></DIV><DIV CLASS="REFSECT1"><A NAME="AEN74597"></A><H2>例子</H2><P>创建一个由所有喜剧电影组成的视图：
</P><PRE CLASS="PROGRAMLISTING">CREATE VIEW comedies AS
    SELECT *
    FROM films
    WHERE kind = 'Comedy';</PRE><P>
这将创建一个视图，包含了在视图创建时<TT CLASS="LITERAL">film</TT>表中的所有字段。
尽管用<TT CLASS="LITERAL">*</TT>创建了该视图，但是后来添加到表中的字段将不会是视图的一部分。</P><P>创建一个由数字1到100组成的递归的视图：
</P><PRE CLASS="PROGRAMLISTING">CREATE RECURSIVE VIEW nums_1_100 (n) AS
    VALUES (1)
UNION ALL
    SELECT n+1 FROM nums_1_100 WHERE n &#60; 100;</PRE><P></P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN74605"></A><H2>兼容性</H2><P>SQL 标准为<TT CLASS="COMMAND">CREATE VIEW</TT>声明了一些附加的功能：
</P><PRE CLASS="SYNOPSIS">CREATE VIEW <TT
CLASS="REPLACEABLE"
><I
>name</I
></TT
> [ ( <TT
CLASS="REPLACEABLE"
><I
>column_name</I
></TT
> [, ...] ) ]
    AS <TT
CLASS="REPLACEABLE"
><I
>query</I
></TT
>
    [ WITH [ CASCADED | LOCAL ] CHECK OPTION ]</PRE><P></P><P>
完整的 SQL 命令可选的子句是：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="LITERAL">CHECK OPTION</TT></DT><DD><P>这个选项控制自动可更新视图的行为。给出时，对视图的<TT CLASS="COMMAND">INSERT</TT>
和<TT CLASS="COMMAND">UPDATE</TT>都要检查以确保新行满足视图定义的条件（也就是说，
新行应该可以通过视图看到）。如果没有通过检查，更新将被拒绝。
如果没有<TT CLASS="LITERAL">CHECK OPTION</TT>，将允许对视图的<TT CLASS="COMMAND">INSERT</TT>
和<TT CLASS="COMMAND">UPDATE</TT>命令创建通过该视图不可见的行。
（后者的行为当前只有<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>提供。）</P></DD><DT><TT CLASS="LITERAL">LOCAL</TT></DT><DD><P>对这个视图进行完整性检查。</P></DD><DT><TT CLASS="LITERAL">CASCADED</TT></DT><DD><P>对此视图和任何依赖的视图进行完整性检查。在既没有声明<TT CLASS="LITERAL">CASCADED</TT>
也没有声明<TT CLASS="LITERAL">LOCAL</TT>时，假设为<TT CLASS="LITERAL">CASCADED</TT>。</P></DD></DL></DIV><P>
</P><P><TT CLASS="COMMAND">CREATE OR REPLACE VIEW</TT>是<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>
的扩展。临时视图的概念也是扩展。<TT CLASS="LITERAL">WITH</TT>子句也是一个扩展。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN74643"></A><H2>又见</H2><A HREF="sql-alterview.html">ALTER VIEW</A>, <A HREF="sql-dropview.html">DROP VIEW</A>, <A HREF="sql-creatematerializedview.html">CREATE MATERIALIZED VIEW</A></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="sql-createusermapping.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="sql-deallocate.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">CREATE USER MAPPING</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/sql-commands.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">DEALLOCATE</TD></TR></TABLE></DIV></BODY></HTML>
