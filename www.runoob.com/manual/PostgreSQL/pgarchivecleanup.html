<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>pg_archivecleanup</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="服务器端应用程序" HREF="contrib-prog-server.html"><LINK REL="PREVIOUS" TITLE="服务器端应用程序" HREF="contrib-prog-server.html"><LINK REL="NEXT" TITLE="pg_standby" HREF="pgstandby.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="REFENTRY">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/pgarchivecleanup.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="服务器端应用程序" HREF="contrib-prog-server.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="contrib-prog-server.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom"></TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="pg_standby" HREF="pgstandby.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><H1><A NAME="PGARCHIVECLEANUP"></A><SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN></H1><DIV CLASS="REFNAMEDIV"><A NAME="AEN151968"></A><H2>&#21517;&#31216;</H2>pg_archivecleanup&nbsp;--&nbsp;清理<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> WAL归档文件</DIV><DIV CLASS="REFSYNOPSISDIV"><A NAME="AEN151974"></A><H2>&#22823;&#32434;</H2><P><TT CLASS="COMMAND">pg_archivecleanup</TT> [<TT CLASS="REPLACEABLE"><I>option</I></TT>...] <TT CLASS="REPLACEABLE"><I>archivelocation</I></TT> <TT CLASS="REPLACEABLE"><I>oldestkeptwalfile</I></TT> </P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN151983"></A><H2>描述</H2><P><SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>被设计来用作<TT CLASS="LITERAL">archive_cleanup_command</TT>，
在作为备用服务器运行时清理WAL文件归档（参阅<A HREF="warm-standby.html">第 25.2 &#33410;</A>）。
<SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>也可以用作一个单独的程序清理WAL文件归档。</P><P>要配置备用服务器使用<SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>，将下列代码放入
<TT CLASS="FILENAME">recovery.conf</TT>配置文件中：
</P><PRE CLASS="PROGRAMLISTING">archive_cleanup_command = 'pg_archivecleanup <TT
CLASS="REPLACEABLE"
><I
>archivelocation</I
></TT
> %r'</PRE><P>
这里的<TT CLASS="REPLACEABLE"><I>archivelocation</I></TT>是应该被移除的WAL段文件的目录。</P><P>当在<A HREF="archive-recovery-settings.html#ARCHIVE-CLEANUP-COMMAND">archive_cleanup_command</A>中使用时，所有逻辑上在<TT CLASS="LITERAL">%r</TT>
参数值之前的WAL文件都将从<TT CLASS="REPLACEABLE"><I>archivelocation</I></TT>中移除。
这在保存崩溃-重启能力时，最小化了需要保留的文件数量。
如果<TT CLASS="REPLACEABLE"><I>archivelocation</I></TT>是这个特殊的备用服务器的瞬态暂存区域，
那么使用这个参数是合适的，但是在<TT CLASS="REPLACEABLE"><I>archivelocation</I></TT>
用作长期WAL归档区，或者多个备用服务器是从同一个归档位置恢复而来的时，
是<SPAN CLASS="emphasis"><I CLASS="EMPHASIS">不</I></SPAN>合适的。</P><P>当用作独立程序时，所有逻辑上在<TT CLASS="REPLACEABLE"><I>oldestkeptwalfile</I></TT>
之前的WAL文件都将从<TT CLASS="REPLACEABLE"><I>archivelocation</I></TT>中移除。
在这个模式中，如果你声明一个<TT CLASS="FILENAME">.backup</TT>文件名，
那么只有文件前缀将被用作<TT CLASS="REPLACEABLE"><I>oldestkeptwalfile</I></TT>。
这允许你无误的删除所有在一个特定基础备份之前归档的WAL文件。
例如，下面的例子将删除所有比WAL文件名<TT CLASS="FILENAME">000000010000003700000010</TT>更老的文件：
</P><PRE CLASS="PROGRAMLISTING">pg_archivecleanup -d archive 000000010000003700000010.00000020.backup

pg_archivecleanup:  keep WAL file "archive/000000010000003700000010" and later
pg_archivecleanup:  removing file "archive/00000001000000370000000F"
pg_archivecleanup:  removing file "archive/00000001000000370000000E"</PRE><P>
</P><P><SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>假设<TT CLASS="REPLACEABLE"><I>archivelocation</I></TT>
是一个服务器所有者用户可读和可写的目录。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN152013"></A><H2>选项</H2><P><SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>接受下列命令行参数：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="OPTION">-d</TT></DT><DD><P>在<TT CLASS="FILENAME">stderr</TT>上打印大量的调试日志输出。</P></DD><DT><TT CLASS="OPTION">-n</TT></DT><DD><P>打印将要在<TT CLASS="FILENAME">stdout</TT>上删除的文件名（执行一个空运行）。</P></DD><DT><TT CLASS="OPTION">-V</TT><BR><TT CLASS="OPTION">--version</TT></DT><DD><P>打印<SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>的版本并退出。</P></DD><DT><TT CLASS="OPTION">-x</TT> <TT CLASS="REPLACEABLE"><I>extension</I></TT></DT><DD><P>当该程序用作单独的工具时，提供一个扩展，该扩展将在决定文件是否应该被删除之前，
提取所有的文件名。这通常在清理在存储时已经压缩了的归档时是有用的，
并且因此有一个由压缩程序添加的扩展。例如：<TT CLASS="LITERAL">-x.gz</TT>。</P><P>请注意，传递到该程序的<TT CLASS="FILENAME">.backup</TT>文件名不应该包含该扩展。</P></DD><DT><TT CLASS="OPTION">-?</TT><BR><TT CLASS="OPTION">--help</TT></DT><DD><P>显示关于<SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>命令行参数的帮助信息，然后退出。</P></DD></DL></DIV><P>
</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN152055"></A><H2>注意</H2><P>当用作单独的工具时，<SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>
是设计在<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 8.0及更新的版本上使用的，
或者用作归档清理命令时，用在<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 9.0及更新的版本上。</P><P><SPAN CLASS="APPLICATION">pg_archivecleanup</SPAN>是用C写的，有一个容易修改的源代码，
有专门指定的部分用来修改以满足你自己的需要。</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN152063"></A><H2>例子</H2><P>在Linux或Unix系统上，你可能使用：
</P><PRE CLASS="PROGRAMLISTING">archive_cleanup_command = 'pg_archivecleanup -d /mnt/standby/archive %r 2&#62;&#62;cleanup.log'</PRE><P>
这里的归档目录的物理位置在备用服务器上，所以<TT CLASS="VARNAME">archive_command</TT>
是通过NFS访问它的，但是文件对于备用服务器是本地的。这将：</P><P></P><UL><LI><P>在<TT CLASS="FILENAME">cleanup.log</TT>中产生调试输出</P></LI><LI><P>从归档目录中移除不再需要的文件</P></LI></UL></DIV><DIV CLASS="REFSECT1"><A NAME="AEN152074"></A><H2>作者</H2><P> Simon Riggs <CODE CLASS="EMAIL">&#60;<A HREF="mailto:simon@2ndquadrant.com">simon@2ndquadrant.com</A>&#62;</CODE>
</P></DIV><DIV CLASS="REFSECT1"><A NAME="AEN152078"></A><H2>又见</H2><A HREF="pgstandby.html"><SPAN CLASS="APPLICATION">pg_standby</SPAN></A></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="contrib-prog-server.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="pgstandby.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">服务器端应用程序</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="contrib-prog-server.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><SPAN CLASS="APPLICATION">pg_standby</SPAN></TD></TR></TABLE></DIV></BODY></HTML>
