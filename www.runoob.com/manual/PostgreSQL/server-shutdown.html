<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>关闭服务器</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="服务器设置和操作" HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime.html"><LINK REL="PREVIOUS" TITLE="管理内核资源" HREF="kernel-resources.html"><LINK REL="NEXT" TITLE="升级一个 PostgreSQL 集群" HREF="upgrading.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/runtime.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="管理内核资源" HREF="kernel-resources.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 17. 服务器设置和操作</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="升级一个 PostgreSQL 集群" HREF="upgrading.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="SERVER-SHUTDOWN">17.5. 关闭服务器</A></H1><P>有好几种关闭数据库服务器的方法。通过给<TT CLASS="COMMAND">postgres</TT>进程发送不同的信号，
你就可以控制关闭服务器的不同方法。
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><SPAN CLASS="SYSTEMITEM">SIGTERM</SPAN></DT><DD><P>这是<I CLASS="FIRSTTERM">智能关闭</I>模式。接收到<SPAN CLASS="SYSTEMITEM">SIGTERM</SPAN>以后，
服务器不再允许新的连接，但是允许所有活跃的会话正常完成他们的工作，
只有在所有会话都结束任务后才关闭。如果服务器处在在线备份模式，它另外等待在线备份模式不再活跃。
当备份模式活跃时，将仍允许新的连接，但是只针对超级用户（这个例外允许超级用户连接以终止在线备份模式）。
如果当请求智能关闭时服务器正在恢复，那么恢复和流复制将在所有普通会话终止后停止。
</P></DD><DT><SPAN CLASS="SYSTEMITEM">SIGINT</SPAN></DT><DD><P>这是<I CLASS="FIRSTTERM">快速关闭</I>模式。不再允许新的连接，向所有活跃服务器发送<SPAN CLASS="SYSTEMITEM">SIGTERM</SPAN>
(让它们立刻退出)，然后等待所有子进程退出并关闭数据库。如果服务器处在在线备份模式，
备份模式将终止，使得备份无效。</P></DD><DT><SPAN CLASS="SYSTEMITEM">SIGQUIT</SPAN></DT><DD><P>这是<I CLASS="FIRSTTERM">立即关闭</I>模式。主<TT CLASS="COMMAND">postgres</TT>进程将向所有子进程发送
<SPAN CLASS="SYSTEMITEM">SIGQUIT</SPAN>并且立即退出(所有子进程也会立即退出)，而不会妥善地关闭数据库系统。
这样做会导致下次启动时的恢复(通过重放 WAL 日志)。我们推荐只在紧急的时候使用这个方法。</P></DD></DL></DIV><P>
</P><P><A HREF="app-pg-ctl.html"><SPAN CLASS="APPLICATION">pg_ctl</SPAN></A>程序提供了一个发送这些信号关闭服务器的便利接口。
另外，你在非Windows系统上可以用<TT CLASS="COMMAND">kill</TT>直接发送这些信号。
可以用<TT CLASS="COMMAND">ps</TT>命令或者从数据目录里的<TT CLASS="FILENAME">postmaster.pid</TT>
文件中找出<TT CLASS="COMMAND">postgres</TT>的<ACRONYM CLASS="ACRONYM">PID</ACRONYM>。所以，举例来说，要做一次快速关闭：
</P><PRE CLASS="SCREEN">$ <KBD
CLASS="USERINPUT"
>kill -INT `head -1 /usr/local/pgsql/data/postmaster.pid`</KBD
></PRE><P>
</P><DIV CLASS="IMPORTANT"><BLOCKQUOTE CLASS="IMPORTANT"><P><B>&#37325;&#35201;: </B>最好不要用<SPAN CLASS="SYSTEMITEM">SIGKILL</SPAN>来关闭服务器。这样做将阻止服务器释放共享内存和信号灯，
那样的话你只能在新服务器启动前自己手动做这件事。另外，<SPAN CLASS="SYSTEMITEM">SIGKILL</SPAN>直接杀死<TT CLASS="COMMAND">postgres</TT>
进程而不等它传递信号给子进程，所以我们也将必须手动的杀死独立的子进程。</P></BLOCKQUOTE></DIV><P>当允许其他会话继续时终止一个独立的会话，使用<CODE CLASS="FUNCTION">pg_terminate_backend()</CODE>
(参见<A HREF="functions-admin.html#FUNCTIONS-ADMIN-SIGNAL-TABLE">&#34920; 9-59</A>)或发送一个<SPAN CLASS="SYSTEMITEM">SIGTERM</SPAN>
信号到与这个会话有关的子进程。</P></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="kernel-resources.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="upgrading.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">管理内核资源</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">升级一个 <SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 集群</TD></TR></TABLE></DIV></BODY></HTML>
