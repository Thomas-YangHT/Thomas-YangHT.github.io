<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>明确的子事务</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="PL/Python - Python 过程语言" HREF="http://school.yunwei.edu/manual/PostgreSQL/plpython.html"><LINK REL="PREVIOUS" TITLE="数据库访问" HREF="plpython-database.html"><LINK REL="NEXT" TITLE="实用函数" HREF="plpython-util.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/plpython.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="数据库访问" HREF="plpython-database.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/plpython.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 43. PL/Python - Python 过程语言</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="实用函数" HREF="plpython-util.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="PLPYTHON-SUBTRANSACTION">43.8. 明确的子事务</A></H1><P>从<A HREF="plpython-database.html#PLPYTHON-TRAPPING">第 43.7.2 &#33410;</A>中描述的数据库访问导致的错误中恢复可能会导致不良情况，
在一个操作失败之前已经有一些操作成功了，之后从错误中恢复使得数据停留在一个不一致的状态。
PL/Python提供了一个解决该问题的方法，以明确的子事务的形式。</P><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="AEN61117">43.8.1. 子事务内容管理器</A></H2><P>考虑一个实现在两个账户之间转换的函数：
</P><PRE CLASS="PROGRAMLISTING">CREATE FUNCTION transfer_funds() RETURNS void AS $$
try:
    plpy.execute("UPDATE accounts SET balance = balance - 100 WHERE account_name = 'joe'")
    plpy.execute("UPDATE accounts SET balance = balance + 100 WHERE account_name = 'mary'")
except plpy.SPIError, e:
    result = "error transferring funds: %s" % e.args
else:
    result = "funds transferred correctly"
plan = plpy.prepare("INSERT INTO operations (result) VALUES ($1)", ["text"])
plpy.execute(plan, [result])
$$ LANGUAGE plpythonu;</PRE><P>
如果第二个<TT CLASS="LITERAL">UPDATE</TT>语句导致异常发生，这个函数将报告该错误，
但是第一个<TT CLASS="LITERAL">UPDATE</TT>的结果将不会提交。换句话说，funds将从Joe的账户中退出，
但是不会转换到Mary的账户。
</P><P>为了避免这样的问题，你可以将你的<TT CLASS="LITERAL">plpy.execute</TT>调用封装在一个明确的子事务中。
<TT CLASS="LITERAL">plpy</TT>模块提供一个帮助对象管理用<TT CLASS="LITERAL">plpy.subtransaction()</TT>
函数创建的明确的子事务。这个函数创建的对象实现了
<A HREF="http://docs.python.org/library/stdtypes.html#context-manager-types" TARGET="_top">内容管理接口</A>。
使用明确的子事务我们可以重写我们的函数为：
</P><PRE CLASS="PROGRAMLISTING">CREATE FUNCTION transfer_funds2() RETURNS void AS $$
try:
    with plpy.subtransaction():
        plpy.execute("UPDATE accounts SET balance = balance - 100 WHERE account_name = 'joe'")
        plpy.execute("UPDATE accounts SET balance = balance + 100 WHERE account_name = 'mary'")
except plpy.SPIError, e:
    result = "error transferring funds: %s" % e.args
else:
    result = "funds transferred correctly"
plan = plpy.prepare("INSERT INTO operations (result) VALUES ($1)", ["text"])
plpy.execute(plan, [result])
$$ LANGUAGE plpythonu;</PRE><P>
请注意，仍然需要<TT CLASS="LITERAL">try/catch</TT>的使用。否则异常将传播到Python堆栈的顶部，
并导致整个函数带有<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>错误退出，所以
<TT CLASS="LITERAL">operations</TT>表将不会有任何行插入。子事务内容管理器并不捕获错误，
它只是保证在它的范围内执行的所有数据库操作都将自动提交或回滚。
一个子事务块的回滚在任何类型的异常退出上发生，不只是起源于数据库访问的错误导致的异常。
一个明确的子事务块内部发生的普通Python异常也会导致子事务回滚。
</P></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="AEN61132">43.8.2. 旧的Python版本</A></H2><P>使用<TT CLASS="LITERAL">with</TT>关键字的内容管理器语法缺省在Python 2.6中可用。
如果用旧的Python版本使用PL/Python，仍然可能使用明确的子事务，尽管不是透明的。
你可以使用方便的别名<TT CLASS="LITERAL">enter</TT>和<TT CLASS="LITERAL">exit</TT>
调用子事务管理器的<TT CLASS="LITERAL">__enter__</TT>和<TT CLASS="LITERAL">__exit__</TT>。
转换funds的例子函数可以写为：
</P><PRE CLASS="PROGRAMLISTING">CREATE FUNCTION transfer_funds_old() RETURNS void AS $$
try:
    subxact = plpy.subtransaction()
    subxact.enter()
    try:
        plpy.execute("UPDATE accounts SET balance = balance - 100 WHERE account_name = 'joe'")
        plpy.execute("UPDATE accounts SET balance = balance + 100 WHERE account_name = 'mary'")
    except:
        import sys
        subxact.exit(*sys.exc_info())
        raise
    else:
        subxact.exit(None, None, None)
except plpy.SPIError, e:
    result = "error transferring funds: %s" % e.args
else:
    result = "funds transferred correctly"

plan = plpy.prepare("INSERT INTO operations (result) VALUES ($1)", ["text"])
plpy.execute(plan, [result])
$$ LANGUAGE plpythonu;</PRE><P>
</P><DIV CLASS="NOTE"><BLOCKQUOTE CLASS="NOTE"><P><B>&#27880;&#24847;: </B>尽管文本管理器是在Python 2.5中实现的，要在该版本中使用<TT CLASS="LITERAL">with</TT>
语法你需要使用一个<A HREF="http://docs.python.org/release/2.5/ref/future.html" TARGET="_top">未来声明</A>。
不过，由于实现的细节，你不能在PL/Python函数中使用未来声明。</P></BLOCKQUOTE></DIV></DIV></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="plpython-database.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="plpython-util.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">数据库访问</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/plpython.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">实用函数</TD></TR></TABLE></DIV></BODY></HTML>
