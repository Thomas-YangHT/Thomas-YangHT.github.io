<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>管理数据库连接</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="ECPG - 在C中嵌入SQL" HREF="http://school.yunwei.edu/manual/PostgreSQL/ecpg.html"><LINK REL="PREVIOUS" TITLE="概念" HREF="ecpg-concept.html"><LINK REL="NEXT" TITLE="运行SQL命令" HREF="ecpg-commands.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/ecpg.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="概念" HREF="ecpg-concept.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/ecpg.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 33. <SPAN CLASS="APPLICATION">ECPG</SPAN> - 在C中嵌入<ACRONYM CLASS="ACRONYM">SQL</ACRONYM></TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="运行SQL命令" HREF="ecpg-commands.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="ECPG-CONNECT">33.2. 管理数据库连接</A></H1><P> 本节描述了如何打开，关闭，以及切换数据库连接。</P><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="ECPG-CONNECTING">33.2.1. 与数据库服务器连接</A></H2><P>
用下面的语句与一个数据库连接：
</P><PRE CLASS="PROGRAMLISTING">EXEC SQL CONNECT TO <TT
CLASS="REPLACEABLE"
><I
>target</I
></TT
> [<SPAN
CLASS="OPTIONAL"
>AS <TT
CLASS="REPLACEABLE"
><I
>connection-name</I
></TT
></SPAN
>] [<SPAN
CLASS="OPTIONAL"
>USER <TT
CLASS="REPLACEABLE"
><I
>user-name</I
></TT
></SPAN
>];</PRE><P>
<TT CLASS="REPLACEABLE"><I>target</I></TT>可以通过下面的方法声明：
<P></P></P><UL><LI><P> <TT CLASS="LITERAL"><TT CLASS="REPLACEABLE"><I>dbname</I></TT>[<SPAN CLASS="OPTIONAL">@<TT CLASS="REPLACEABLE"><I>hostname</I></TT></SPAN>][<SPAN CLASS="OPTIONAL">:<TT CLASS="REPLACEABLE"><I>port</I></TT></SPAN>]</TT>
</P></LI><LI><P> <TT CLASS="LITERAL">tcp:postgresql://<TT CLASS="REPLACEABLE"><I>hostname</I></TT>[<SPAN CLASS="OPTIONAL">:<TT CLASS="REPLACEABLE"><I>port</I></TT></SPAN>][<SPAN CLASS="OPTIONAL">/<TT CLASS="REPLACEABLE"><I>dbname</I></TT></SPAN>][<SPAN CLASS="OPTIONAL">?<TT CLASS="REPLACEABLE"><I>options</I></TT></SPAN>]</TT>
</P></LI><LI><P> <TT CLASS="LITERAL">unix:postgresql://<TT CLASS="REPLACEABLE"><I>hostname</I></TT>[<SPAN CLASS="OPTIONAL">:<TT CLASS="REPLACEABLE"><I>port</I></TT></SPAN>][<SPAN CLASS="OPTIONAL">/<TT CLASS="REPLACEABLE"><I>dbname</I></TT></SPAN>][<SPAN CLASS="OPTIONAL">?<TT CLASS="REPLACEABLE"><I>options</I></TT></SPAN>]</TT>
</P></LI><LI><P>
一个包含上面形式的SQL字串文本
</P></LI><LI><P>
一个对包含上面的形式之一的字符串变量的引用
</P></LI><LI><P> <TT CLASS="LITERAL">DEFAULT</TT>
</P></LI></UL><P>
如果你用文本声明连接目标（也就是说，不是通过一个变量引用），
而且你也不引用这个数值，那么使用普通SQL的大小写无关的规则。
这种情况下，你也可以根据需要独立地对参数使用双引号包围。
实际上，可能用一个（单引号包围）的
字串文本或者变量引用作为连接目标可能更结实一些。
连接目标<TT CLASS="LITERAL">DEFAULT</TT>发起一个用缺省用户名对缺省数据库地连接。
这个时候不应该声明用户名或连接名。
</P><P>
声明用户名的方法也有几种不同方式：
<P></P></P><UL><LI><P> <TT CLASS="LITERAL"><TT CLASS="REPLACEABLE"><I>username</I></TT></TT>
</P></LI><LI><P> <TT CLASS="LITERAL"><TT CLASS="REPLACEABLE"><I>username</I></TT>/<TT CLASS="REPLACEABLE"><I>password</I></TT></TT>
</P></LI><LI><P> <TT CLASS="LITERAL"><TT CLASS="REPLACEABLE"><I>username</I></TT> IDENTIFIED BY <TT CLASS="REPLACEABLE"><I>password</I></TT></TT>
</P></LI><LI><P> <TT CLASS="LITERAL"><TT CLASS="REPLACEABLE"><I>username</I></TT> USING <TT CLASS="REPLACEABLE"><I>password</I></TT></TT>
</P></LI></UL><P>
正如上面的一样，参数用户名和密码可以是一个SQL标识，
一个字符变量，或者一个字符串。
</P><P><TT CLASS="REPLACEABLE"><I>连接名</I></TT>用于处理一个程序里的多个连接。
如果一个程序只使用一个连接，则可以省略它。
最近打开的连接成为当前连接，
在准备执行SQL语句的时候，缺省时会使用这个连接（参阅本章稍后部分）。</P><P>
这里是一些<TT CLASS="COMMAND">CONNECT</TT>语句的例子：
</P><PRE CLASS="PROGRAMLISTING">EXEC SQL CONNECT TO mydb@sql.mydomain.com;

EXEC SQL CONNECT TO unix:postgresql://sql.mydomain.com/mydb AS myconnection USER john;

EXEC SQL BEGIN DECLARE SECTION;
const char *target = "mydb@sql.mydomain.com";
const char *user = "john";
const char *passwd = "secret";
EXEC SQL END DECLARE SECTION;
 ...
EXEC SQL CONNECT TO :target USER :user USING :passwd;
/* or EXEC SQL CONNECT TO :target USER :user/:passwd; */</PRE><P>
最后的一个形式使用了上面说过的变量引用的方法。
在后面的小节里你会看到在SQL语句里如何使用前缀了冒号的C变量。
</P><P> 请注意连接目标的格式没有在SQL标准里说明。所以，
如果你想开发可以移植的应用，
你可能会想使用类似上面的最后一个例子这样的方法来把连接目标字串封装在某处。</P></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="ECPG-SET-CONNECTION">33.2.2. 选择一个连接</A></H2><P> 在当前连接中缺省执行嵌入SQL程序的SQL语句，也就是说，最近打开的。
如果应用需要管理多个连接，那么有两种处理方法。</P><P>
第一个选项是为每个SQL语句明确选择一个连接，比如:
</P><PRE CLASS="PROGRAMLISTING">EXEC SQL AT <TT
CLASS="REPLACEABLE"
><I
>connection-name</I
></TT
> SELECT ...;</PRE><P>
如果在混合顺序中应用程序需要使用若干个连接时，这个选项特别适合。
</P><P> 如果你的应用程序使用多个执行线程，他们不能同时共享连接。
你要么明确控制访问连接（使用互斥锁）或者为每个线程使用一个连接。
如果每个线程使用自己的连接，你将需要使用AT子句指定线程将使用哪个连接。</P><P>
第二个选项是执行语句切换当前连接。语句是：
</P><PRE CLASS="PROGRAMLISTING">EXEC SQL SET CONNECTION <TT
CLASS="REPLACEABLE"
><I
>connection-name</I
></TT
>;</PRE><P>
如果在同一个连接上执行许多语句，那么这种选择很方便。它不是线程感知的。
</P><P>
这里有一个管理多个数据库连接的例子程序：
</P><PRE CLASS="PROGRAMLISTING">#include &#60;stdio.h&#62;

EXEC SQL BEGIN DECLARE SECTION;
    char dbname[1024];
EXEC SQL END DECLARE SECTION;

int
main()
{
    EXEC SQL CONNECT TO testdb1 AS con1 USER testuser;
    EXEC SQL CONNECT TO testdb2 AS con2 USER testuser;
    EXEC SQL CONNECT TO testdb3 AS con3 USER testuser;
   
/*在最后打开的数据库"testdb3"中执行该查询*/
    EXEC SQL SELECT current_database() INTO :dbname;
    printf("current=%s (should be testdb3)\n", dbname);
    

/*在"testdb2"中使用"AT"运行查询*/

    EXEC SQL AT con2 SELECT current_database() INTO :dbname;
    printf("current=%s (should be testdb2)\n", dbname);

/*切换当前连接到"testdb1" */

    EXEC SQL SET CONNECTION con1;

    EXEC SQL SELECT current_database() INTO :dbname;
    printf("current=%s (should be testdb1)\n", dbname);

    EXEC SQL DISCONNECT ALL;
    return 0;
}</PRE><P>
这个例子可能产生这样的输出:
</P><PRE CLASS="SCREEN">current=testdb3 (should be testdb3)
current=testdb2 (should be testdb2)
current=testdb1 (should be testdb1)</PRE><P>
</P></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="ECPG-DISCONNECT">33.2.3. 关闭一个连接</A></H2><P>
使用下面的语句关闭连接：
</P><PRE CLASS="PROGRAMLISTING">EXEC SQL DISCONNECT [<SPAN
CLASS="OPTIONAL"
><TT
CLASS="REPLACEABLE"
><I
>connection</I
></TT
></SPAN
>];</PRE><P>
通过下面的方法声明<TT CLASS="REPLACEABLE"><I>连接</I></TT>:
<P></P></P><UL><LI><P>
<TT CLASS="LITERAL"><TT CLASS="REPLACEABLE"><I>连接名</I></TT></TT>
</P></LI><LI><P>
<TT CLASS="LITERAL">缺省</TT>
</P></LI><LI><P>
<TT CLASS="LITERAL">当前</TT>
</P></LI><LI><P>
<TT CLASS="LITERAL">所有</TT>
</P></LI></UL><P>
如果没有声明连接名，那么关闭当前连接。
</P><P> 应用保持明确关闭每次打开的连接是一个很好的习惯。 </P></DIV></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="ecpg-concept.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="ecpg-commands.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">概念</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/ecpg.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">运行SQL命令</TD></TR></TABLE></DIV></BODY></HTML>
