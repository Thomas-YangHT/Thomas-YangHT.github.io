<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>错误和消息</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="PL/pgSQL - SQL过程语言" HREF="http://school.yunwei.edu/manual/PostgreSQL/plpgsql.html"><LINK REL="PREVIOUS" TITLE="游标" HREF="plpgsql-cursors.html"><LINK REL="NEXT" TITLE="触发器过程" HREF="plpgsql-trigger.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/plpgsql.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="游标" HREF="plpgsql-cursors.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/plpgsql.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 40. <SPAN CLASS="APPLICATION">PL/pgSQL</SPAN> - <ACRONYM CLASS="ACRONYM">SQL</ACRONYM>过程语言</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="触发器过程" HREF="plpgsql-trigger.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="PLPGSQL-ERRORS-AND-MESSAGES">40.8. 错误和消息</A></H1><P>
利用<TT CLASS="COMMAND">RAISE</TT>语句报告信息以及抛出错误。
</P><PRE CLASS="SYNOPSIS">RAISE [<SPAN
CLASS="OPTIONAL"
> <TT
CLASS="REPLACEABLE"
><I
>level</I
></TT
> </SPAN
>] '<TT
CLASS="REPLACEABLE"
><I
>format</I
></TT
>' [<SPAN
CLASS="OPTIONAL"
>, <TT
CLASS="REPLACEABLE"
><I
>expression</I
></TT
> [<SPAN
CLASS="OPTIONAL"
>, ... </SPAN
>]</SPAN
>] [<SPAN
CLASS="OPTIONAL"
> USING <TT
CLASS="REPLACEABLE"
><I
>option</I
></TT
> = <TT
CLASS="REPLACEABLE"
><I
>expression</I
></TT
> [<SPAN
CLASS="OPTIONAL"
>, ... </SPAN
>] </SPAN
>];
RAISE [<SPAN
CLASS="OPTIONAL"
> <TT
CLASS="REPLACEABLE"
><I
>level</I
></TT
> </SPAN
>] <TT
CLASS="REPLACEABLE"
><I
>condition_name</I
></TT
> [<SPAN
CLASS="OPTIONAL"
> USING <TT
CLASS="REPLACEABLE"
><I
>option</I
></TT
> = <TT
CLASS="REPLACEABLE"
><I
>expression</I
></TT
> [<SPAN
CLASS="OPTIONAL"
>, ... </SPAN
>] </SPAN
>];
RAISE [<SPAN
CLASS="OPTIONAL"
> <TT
CLASS="REPLACEABLE"
><I
>level</I
></TT
> </SPAN
>] SQLSTATE '<TT
CLASS="REPLACEABLE"
><I
>sqlstate</I
></TT
>' [<SPAN
CLASS="OPTIONAL"
> USING <TT
CLASS="REPLACEABLE"
><I
>option</I
></TT
> = <TT
CLASS="REPLACEABLE"
><I
>expression</I
></TT
> [<SPAN
CLASS="OPTIONAL"
>, ... </SPAN
>] </SPAN
>];
RAISE [<SPAN
CLASS="OPTIONAL"
> <TT
CLASS="REPLACEABLE"
><I
>level</I
></TT
> </SPAN
>] USING <TT
CLASS="REPLACEABLE"
><I
>option</I
></TT
> = <TT
CLASS="REPLACEABLE"
><I
>expression</I
></TT
> [<SPAN
CLASS="OPTIONAL"
>, ... </SPAN
>];
RAISE ;</PRE><P>
<TT CLASS="REPLACEABLE"><I>level</I></TT>选项声明了错误的严重性等级。
可能的级别有<TT CLASS="LITERAL">DEBUG</TT>,<TT CLASS="LITERAL">LOG</TT>, <TT CLASS="LITERAL">INFO</TT>,
<TT CLASS="LITERAL">NOTICE</TT>, <TT CLASS="LITERAL">WARNING</TT>,
和<TT CLASS="LITERAL">EXCEPTION</TT>，默认的是<TT CLASS="LITERAL">EXCEPTION</TT>。
<TT CLASS="LITERAL">EXCEPTION</TT>会抛出一个错误（强制关闭当前事务），
而其他级别仅仅是产生不同的优先级信息。
无论是将优先级别的信息是报告给客户端，还是写到服务器日志，亦或是二者都是，
都是由<A HREF="runtime-config-logging.html#GUC-LOG-MIN-MESSAGES">log_min_messages</A>和<A HREF="runtime-config-logging.html#GUC-CLIENT-MIN-MESSAGES">client_min_messages</A>配置变量控制的。
参阅<A HREF="http://school.yunwei.edu/manual/PostgreSQL/runtime-config.html">第 18 &#31456;</A>获取更多细节。
</P><P> 如果真有的话，在<TT CLASS="REPLACEABLE"><I>level</I></TT>之后，
你可以写<TT CLASS="REPLACEABLE"><I>format</I></TT>，
（这必须是一个简单的字符串文本，而不是表达式）。
格式字符串声明要报告的错误信息文本。
格式字符串可以遵循插入到信息中的可选参数表达式。
在格式字符串里，<TT CLASS="LITERAL">%</TT>被下一个可选参数的外部表现形式代替。
要表示<TT CLASS="LITERAL">%</TT>字符必须发出(<TT CLASS="LITERAL">%%</TT>)。&#13;</P><P>
在这个例子里，<TT CLASS="LITERAL">v_job_id</TT>的值将代替字符串中的<TT CLASS="LITERAL">%</TT>：
</P><PRE CLASS="PROGRAMLISTING">RAISE NOTICE 'Calling cs_create_job(%)', v_job_id;</PRE><P>
</P><P>
你可以通过在<TT CLASS="REPLACEABLE"><I>option</I></TT> = <TT CLASS="REPLACEABLE"><I>expression</I></TT>项后边写<TT CLASS="LITERAL">USING</TT>来附加额外信息到错误报告中。
每一个<TT CLASS="REPLACEABLE"><I>expression</I></TT>可以是任何字符串值表达式。
允许的<TT CLASS="REPLACEABLE"><I>option</I></TT>关键字是：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="LITERAL">MESSAGE</TT></DT><DD><P>
设置错误消息文本。这个选项不能用于包含<TT CLASS="LITERAL">USING</TT>之前的格式字符串
的<TT CLASS="COMMAND">RAISE</TT>形式中。</P></DD><DT><TT CLASS="LITERAL">DETAIL</TT></DT><DD><P> 提供一个错误详细信息。</P></DD><DT><TT CLASS="LITERAL">HINT</TT></DT><DD><P> 提供提示信息。</P></DD><DT><TT CLASS="LITERAL">ERRCODE</TT></DT><DD><P> 指定错误代码（SQLSTATE）用来报告，通过条件名，
如<A HREF="http://school.yunwei.edu/manual/PostgreSQL/errcodes-appendix.html">&#38468;&#24405; A</A>，或直接作为
五个字符的SQLSTATE代码。</P></DD><DT><TT CLASS="LITERAL">COLUMN</TT><BR><TT CLASS="LITERAL">CONSTRAINT</TT><BR><TT CLASS="LITERAL">DATATYPE</TT><BR><TT CLASS="LITERAL">TABLE</TT><BR><TT CLASS="LITERAL">SCHEMA</TT></DT><DD><P> 提供一个相关对象名称。</P></DD></DL></DIV><P>
</P><P>
该例子会强制退出事务，并返回如下提示：
</P><PRE CLASS="PROGRAMLISTING">RAISE EXCEPTION 'Nonexistent ID --&#62; %', user_id
      USING HINT = 'Please check your user ID';</PRE><P>
</P><P>
下面两个例子在设置SQLSTATE方面具有相同的作用：
</P><PRE CLASS="PROGRAMLISTING">RAISE 'Duplicate user ID: %', user_id USING ERRCODE = 'unique_violation';
RAISE 'Duplicate user ID: %', user_id USING ERRCODE = '23505';</PRE><P>
</P><P>
这是第二个<TT CLASS="COMMAND">RAISE</TT>语法，其中主要参数是条件名字或者要报告的SQLSTATE，比如：
</P><PRE CLASS="PROGRAMLISTING">RAISE division_by_zero;
RAISE SQLSTATE '22012';</PRE><P>
在这个语法中，<TT CLASS="LITERAL">USING</TT>可以来提供一个通用的错误信息，详情，或者提示。另一个较早的例子是：
</P><PRE CLASS="PROGRAMLISTING">RAISE unique_violation USING MESSAGE = 'Duplicate user ID: ' || user_id;</PRE><P>
</P><P> 另一个变形是
写<TT CLASS="LITERAL">RAISE USING</TT>或者<TT CLASS="LITERAL">RAISE<TT CLASS="REPLACEABLE"><I>level</I></TT> USING</TT>，
然后将其他的所有东西都放在<TT CLASS="LITERAL">USING</TT>列中。</P><P>最后一个<TT CLASS="COMMAND">RAISE</TT>变形中没有任何参数。
这种形式只能在<TT CLASS="LITERAL">BEGIN</TT>块的<TT CLASS="LITERAL">EXCEPTION</TT>字句中使用。
它的作用是将正在处理的错误放到下一个封闭的块中。</P><DIV CLASS="NOTE"><BLOCKQUOTE CLASS="NOTE"><P><B>&#27880;&#24847;: </B>
在<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 9.1之前，
没有参数的<TT CLASS="COMMAND">RAISE</TT>被解释为
包含有活跃异常处理程序的块中重新抛出错误。
因此，<TT CLASS="LITERAL">EXCEPTION</TT>子句嵌套在该处理器中无法抓取它，即使
<TT CLASS="COMMAND">RAISE</TT>在嵌套的<TT CLASS="LITERAL">EXCEPTION</TT>子句块中。
这被认为是令人惊讶并且不兼容Oracle的PL/SQL。&#13;</P></BLOCKQUOTE></DIV><P>如果<TT CLASS="COMMAND">RAISE EXCEPTION</TT>中没有声明SQLSTATE的情形名称，
那么缺省使用<TT CLASS="LITERAL">RAISE_EXCEPTION</TT> (<TT CLASS="LITERAL">P0001</TT>)。
如果没有声明信息文本，那么缺省将情形名称或SQLSTATE作为信息文本。</P><DIV CLASS="NOTE"><BLOCKQUOTE CLASS="NOTE"><P><B>&#27880;&#24847;: </B> 当通过SQLSTATE编码声明一个错误代码时，你不能限制预定义错误代码，
但是可以选择任何由五个数字和/或者大写ASCII字母组成的错误代码，
而不是<TT CLASS="LITERAL">00000</TT>。建议避免抛出以三个零结尾的错误代码，因为
这些是类别码并且只能通过捕获整个类别来获取。&#13;</P></BLOCKQUOTE></DIV></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="plpgsql-cursors.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="plpgsql-trigger.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">游标</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/plpgsql.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">触发器过程</TD></TR></TABLE></DIV></BODY></HTML>
