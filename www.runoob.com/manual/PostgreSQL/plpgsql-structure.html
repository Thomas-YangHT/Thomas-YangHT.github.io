<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>PL/pgSQL的结构</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="PL/pgSQL - SQL过程语言" HREF="http://school.yunwei.edu/manual/PostgreSQL/plpgsql.html"><LINK REL="PREVIOUS" TITLE="概述" HREF="plpgsql-overview.html"><LINK REL="NEXT" TITLE="声明" HREF="plpgsql-declarations.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/plpgsql.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="概述" HREF="plpgsql-overview.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/plpgsql.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 40. <SPAN CLASS="APPLICATION">PL/pgSQL</SPAN> - <ACRONYM CLASS="ACRONYM">SQL</ACRONYM>过程语言</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="声明" HREF="plpgsql-declarations.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="PLPGSQL-STRUCTURE">40.2. <SPAN CLASS="APPLICATION">PL/pgSQL</SPAN>的结构</A></H1><P>
<SPAN CLASS="APPLICATION">PL/pgSQL</SPAN>是一种块结构的语言。
函数定义的所有文本都必须是一个块（<I CLASS="FIRSTTERM">block</I>）。
可以用下面的方法定义一个块：
</P><PRE CLASS="SYNOPSIS">[<SPAN
CLASS="OPTIONAL"
> &lt;&lt;<TT
CLASS="REPLACEABLE"
><I
>label</I
></TT
>&gt;&gt; </SPAN
>]
[<SPAN
CLASS="OPTIONAL"
> DECLARE
    <TT
CLASS="REPLACEABLE"
><I
>declarations</I
></TT
> </SPAN
>]
BEGIN
    <TT
CLASS="REPLACEABLE"
><I
>statements</I
></TT
>
END [<SPAN
CLASS="OPTIONAL"
> <TT
CLASS="REPLACEABLE"
><I
>label</I
></TT
> </SPAN
>];</PRE><P>
</P><P> 块中的每个声明和每条语句都是用一个分号终止的，
如果一个子块在另外一个块里，那么<TT CLASS="LITERAL">END</TT>后面必须有个分号，如上所述；
不过结束函数体的最后的<TT CLASS="LITERAL">END</TT>可以不要这个分号。</P><DIV CLASS="TIP"><BLOCKQUOTE CLASS="TIP"><P><B>&#25552;&#31034;: </B> 一个常见的错误是紧跟在<TT CLASS="LITERAL">BEGIN</TT>之后使用一个分号，
这是不正确的，并且会返回一个语法错误。</P></BLOCKQUOTE></DIV><P> 如果你想标记出在<TT CLASS="LITERAL">EXIT</TT>声明中的block，或者描述在block中所声明的变量名字，
此时，可以选择使用<TT CLASS="REPLACEABLE"><I>label</I></TT>。如果是在<TT CLASS="LITERAL">END</TT>之后给出一个标签，那么，
它必须与block开始时定义的标签相匹配。</P><P> 所有的关键字都是不区分大小写的，正如在SQL命令中一样，
会隐式的将其转换成小写，除非是使用双引号。 </P><P> 如同在普通的SQL语句中一样，在<SPAN CLASS="APPLICATION">PL/pgSQL</SPAN>代码中，用同样的方式定义注释：
在语句的最后，通过一个双破折号(<TT CLASS="LITERAL">--</TT>)来开始一条行注释。
而块注释是成对出现的，
通过<TT CLASS="LITERAL">/*</TT>和<TT CLASS="LITERAL">*/</TT>来定义。</P><P> 块语句段里的任何语句都可以是一个<I CLASS="FIRSTTERM">子块</I>。子块可以用于逻辑
分组或者把变量局部化为作用于一个较小的语句组。为了子块的持续时间任何同样命名的外部子块的变量在子块中声明变量，
但是如果你符合它们的名字和它们子块标签，无论如何你可以访问外部变量，比如：
</P><PRE CLASS="PROGRAMLISTING">CREATE FUNCTION somefunc() RETURNS integer AS $$
&lt;&lt; outerblock &gt;&gt;
DECLARE
    quantity integer := 30;
BEGIN
    
RAISE NOTICE 'Quantity here is %', quantity;  -- 在这里的数量是30
    quantity := 50;
    --
-- 创建一个子块
    --
    DECLARE
        quantity integer := 80;
    BEGIN
    
RAISE NOTICE 'Quantity here is %', quantity;  -- 在这里的数量是80
        RAISE NOTICE 'Outer quantity here is %', outerblock.quantity;  -- 在这里的数量是50
    END;
    
RAISE NOTICE 'Quantity here is %', quantity;  -- 在这里的数量是50

    RETURN quantity;
END;
$$ LANGUAGE plpgsql;</PRE><P>
</P><DIV CLASS="NOTE"><BLOCKQUOTE CLASS="NOTE"><P><B>&#27880;&#24847;: </B> 在任何<SPAN CLASS="APPLICATION">PL/pgSQL</SPAN>函数主体周围有隐藏的<SPAN CLASS="QUOTE">"外部块"</SPAN>。
这个块提供了函数参数的声明（如果有），以及一些特殊变量比如 <TT CLASS="LITERAL">FOUND</TT>
(参阅<A HREF="plpgsql-statements.html#PLPGSQL-STATEMENTS-DIAGNOSTICS">第 40.5.5 &#33410;</A>)。
外部块可以使用函数的名字标记，意味着参数和特殊变量可以满足函数名字。</P></BLOCKQUOTE></DIV><P> 一定不要把<SPAN CLASS="APPLICATION">PL/pgSQL</SPAN>里用于语句分组的<TT CLASS="COMMAND">BEGIN</TT>/<TT CLASS="COMMAND">END</TT>和用于事务控制的数据库命令搞混了。
<SPAN CLASS="APPLICATION">PL/pgSQL</SPAN>的<TT CLASS="COMMAND">BEGIN</TT>/<TT CLASS="COMMAND">END</TT>只是用于分组；它们不会开始和结束一个事务。
函数和触发器过程总是在一个由外层命令建立起来的事务里执行，
它们无法开始或者提交事务，因为PostgreSQL没有嵌套事务。
不过，一个包含<TT CLASS="LITERAL">EXCEPTION</TT>子句的块实际上形成一个子事务，
它可以在不影响外层事务的情况下回滚。更多相关信息请参阅<A HREF="plpgsql-control-structures.html#PLPGSQL-ERROR-TRAPPING">第 40.6.6 &#33410;</A>。</P></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="plpgsql-overview.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="plpgsql-declarations.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">概述</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/plpgsql.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">声明</TD></TR></TABLE></DIV></BODY></HTML>
