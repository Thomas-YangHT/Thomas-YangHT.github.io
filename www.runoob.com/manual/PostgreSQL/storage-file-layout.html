<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>数据库文件布局</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="数据库物理存储" HREF="http://school.yunwei.edu/manual/PostgreSQL/storage.html"><LINK REL="PREVIOUS" TITLE="数据库物理存储" HREF="http://school.yunwei.edu/manual/PostgreSQL/storage.html"><LINK REL="NEXT" TITLE="TOAST" HREF="storage-toast.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/storage.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="数据库物理存储" HREF="http://school.yunwei.edu/manual/PostgreSQL/storage.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/storage.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 58. 数据库物理存储</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="TOAST" HREF="storage-toast.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="STORAGE-FILE-LAYOUT">58.1. 数据库文件布局</A></H1><P>本节在文件和目录的层次上描述存储格式。</P><P> 传统上，数据库集群所需要的配置和数据文件都存储在集群的数据目录里，
该数据目录通常记录在环境变量<TT CLASS="VARNAME">PGDATA</TT>中（用于定义它的环境变量名称之后）。
一个较常用的<TT CLASS="VARNAME">PGDATA</TT>值是<TT CLASS="FILENAME">/var/lib/pgsql/data</TT>。
不同服务器实例管理的多个集群，
可以在同一台机器上共存。</P><P><TT CLASS="VARNAME">PGDATA</TT>目录包含一些子目录和控制文件，在<A HREF="storage-file-layout.html#PGDATA-CONTENTS-TABLE">&#34920; 58-1</A>中显示。
除了这些必要的东西外，集群配置文件<TT CLASS="FILENAME">postgresql.conf</TT>、
<TT CLASS="FILENAME">pg_hba.conf</TT>和
<TT CLASS="FILENAME">pg_ident.conf</TT>通常也存储在<TT CLASS="VARNAME">PGDATA</TT>这里。
(尽管<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN> 8.0和之后版本，有可能把它们放在其他地方）。&#13;</P><DIV CLASS="TABLE"><A NAME="PGDATA-CONTENTS-TABLE"></A><P><B>&#34920; 58-1. <TT CLASS="VARNAME">PGDATA</TT>内容</B></P><TABLE BORDER="1" CLASS="CALSTABLE"><COL><COL><THEAD><TR><TH>项</TH><TH>描述</TH></TR></THEAD><TBODY><TR><TD><TT CLASS="FILENAME">PG_VERSION</TT></TD><TD>一个包含<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>主版本号的文件</TD></TR><TR><TD><TT CLASS="FILENAME">base</TT></TD><TD>与每个数据库对应的子目录存储在该目录中</TD></TR><TR><TD><TT CLASS="FILENAME">global</TT></TD><TD>集群范围的表存储在该目录中，比如<TT CLASS="STRUCTNAME">pg_database</TT></TD></TR><TR><TD><TT CLASS="FILENAME">pg_clog</TT></TD><TD>包含事务提交状态数据的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">pg_multixact</TT></TD><TD>包含多重事务状态数据的子目录(使用共享的行锁)</TD></TR><TR><TD><TT CLASS="FILENAME">pg_notify</TT></TD><TD>包含LISTEN/NOTIFY状态数据的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">pg_serial</TT></TD><TD>包含已提交可串行化事务信息的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">pg_snapshots</TT></TD><TD>包含输出快照的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">pg_stat_tmp</TT></TD><TD>用于统计子系统的临时文件存储在该目录中</TD></TR><TR><TD><TT CLASS="FILENAME">pg_subtrans</TT></TD><TD>包含子事务状态数据的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">pg_tblspc</TT></TD><TD>包含指向表空间的符号链接的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">pg_twophase</TT></TD><TD>包含用于预备事务的状态文件的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">pg_xlog</TT></TD><TD>包含WAL(预写日志)文件的子目录</TD></TR><TR><TD><TT CLASS="FILENAME">postmaster.opts</TT></TD><TD>一个记录服务器最后一次启动时使用的命令行参数的文件</TD></TR><TR><TD><TT CLASS="FILENAME">postmaster.pid</TT></TD><TD>一个锁文件，
记录当前服务器主进程ID(PID)，集群数据目录路径，服务器启动时间戳，端口号，
Unix-域套接目录路径（Windows上为空），第一个有效listen_address(IP地址或者<TT CLASS="LITERAL">*</TT>，
如果不监听TCP，则为空)，以及共享内存段ID，
（在服务器关闭之后此文件就不存在了）。</TD></TR></TBODY></TABLE></DIV><P> 对于集群里的每个数据库，在<TT CLASS="VARNAME">PGDATA</TT><TT CLASS="FILENAME">/base</TT>里都有对应的一个子目录，
子目录的名字是该数据库在<TT CLASS="STRUCTNAME">pg_database</TT>里的OID。
这个目录是数据库文件的缺省位置；特别值得一提的是，
该数据库的系统表存储于此。</P><P> 每个表和索引都存储在单独的文件中，对于普通关系，这些文件
以该表或者该索引的<I CLASS="FIRSTTERM">filenode</I>值命名，
该值可以在<TT CLASS="STRUCTNAME">pg_class</TT>.<TT CLASS="STRUCTFIELD">relfilenode</TT>中找到。
但对于临时关系，其以<TT CLASS="LITERAL">t<TT CLASS="REPLACEABLE"><I>BBB</I></TT>_<TT CLASS="REPLACEABLE"><I>FFF</I></TT></TT>这样的形式作为文件名，
其中<TT CLASS="REPLACEABLE"><I>BBB</I></TT>是创建文件的后端ID，<TT CLASS="REPLACEABLE"><I>FFF</I></TT>是filenode值。
在任何情况下，除了主文件（a/k/a主分支文件），
每个表和索引有<I CLASS="FIRSTTERM">空闲空间映射</I>（参阅<A HREF="storage-fsm.html">第 58.3 &#33410;</A>）,
其用来存储关系中空闲空间的相关信息。
空闲空间映射存储在以filenode值加后缀<TT CLASS="LITERAL">_fsm</TT>命名的文件中。
表也有<I CLASS="FIRSTTERM">可见映射</I>，存储在一个后缀为<TT CLASS="LITERAL">_vm</TT>的分支文件中，
用来跟踪那些没有无效元组的页，
该可见映射在<A HREF="storage-vm.html">第 58.4 &#33410;</A>中进一步的描述。
不记录日志的表和索引有第三个分支，被称之为初始化分支，其存储在一个后缀为<TT CLASS="LITERAL">_init</TT>
的分支文件中（参阅<A HREF="storage-init.html">第 58.5 &#33410;</A>）。</P><DIV CLASS="CAUTION"><P></P><TABLE CLASS="CAUTION" BORDER="1" WIDTH="100%"><TR><TD ALIGN="CENTER"><B>&#23567;&#24515;</B></TD></TR><TR><TD ALIGN="LEFT"><P> 请注意，虽然一个表的filenode通常和它的OID相同，但实际上并<SPAN CLASS="emphasis"><I CLASS="EMPHASIS">非</I></SPAN>必须如此；
有些操作，比如<TT CLASS="COMMAND">TRUNCATE</TT>, <TT CLASS="COMMAND">REINDEX</TT>, <TT CLASS="COMMAND">CLUSTER</TT>
以及一些特殊的<TT CLASS="COMMAND">ALTER TABLE</TT>命令，
都可以改变filenode而同时保留OID。应该避免filenode和表OID相同这样的假定。
还有，对于某种系统表包括<TT CLASS="STRUCTNAME">pg_class</TT>自身，
<TT CLASS="STRUCTNAME">pg_class</TT>.<TT CLASS="STRUCTFIELD">relfilenode</TT>包含零。
这些表的实际的filenode值存储在更底层的数据结构中，
可以使用<CODE CLASS="FUNCTION">pg_relation_filenode()</CODE>函数获取。</P></TD></TR></TABLE></DIV><P> 在表或者索引超过1GB之后，将被分割为1GB大小的<I CLASS="FIRSTTERM">段</I>。
第一个段的文件名和filenode相同；
随后的段名为filenode.1, filenode.2 ... 等等。
这样可以避免在某些平台上文件大小限制的问题。
（实际上，1GB只是缺省的段大小。当构建<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>时，
可以使用配置选项<TT CLASS="OPTION">--with-segsize</TT>调整段大小。）
原则上，空闲空间映射和可见映射分支文件可能需要多个段，
尽管这在实践中不可能发生。</P><P> 一个表如果有些字段里面可能存储相当大的数据，
那么就会有个相关联的<I CLASS="FIRSTTERM">TOAST</I>表，
用于存储无法在表的数据行中放置的超大行外数据。
如果有的话，<TT CLASS="STRUCTNAME">pg_class</TT>.<TT CLASS="STRUCTFIELD">reltoastrelid</TT>
会从一个表链接到它的<ACRONYM CLASS="ACRONYM">TOAST</ACRONYM>表。
参阅<A HREF="storage-toast.html">第 58.2 &#33410;</A>获取更多信息。</P><P> 表和索引的内容在<A HREF="storage-page-layout.html">第 58.6 &#33410;</A>中有讨论。</P><P> 表空间把情况搞得更复杂些。
每个用户定义的表空间都在<TT CLASS="VARNAME">PGDATA</TT><TT CLASS="FILENAME">/pg_tblspc</TT>目录里面有一个符号连接，
它指向物理的表空间目录(就是在<TT CLASS="COMMAND">CREATE TABLESPACE</TT>命令里声明的那个目录)。
这个符号连接是用表空间的 OID 命名的。
在物理的表空间目录内部，有个依赖<SPAN CLASS="PRODUCTNAME">PostgreSQL</SPAN>服务器版本的命名的子目录，
如<TT CLASS="LITERAL">PG_9.0_201008051</TT>。
（使用这个子目录的原因是为了让后续版本的数据库在不产生冲突的情况下，
可以使用相同的<TT CLASS="COMMAND">CREATE TABLESPACE</TT>位置值。）
在指定版本的子目录里，每个有元素的数据库都会在表空间中有一个子目录，
该子目录以数据库的OID命名。表和索引存储在该目录中，
使用filenode命名。<TT CLASS="LITERAL">pg_default</TT>表空间不用通过<TT CLASS="FILENAME">pg_tblspc</TT>访问，
其与<TT CLASS="VARNAME">PGDATA</TT><TT CLASS="FILENAME">/base</TT>目录对应。与此类似
<TT CLASS="LITERAL">pg_global</TT>也不用通过<TT CLASS="FILENAME">pg_tblspc</TT>访问，
其与<TT CLASS="VARNAME">PGDATA</TT><TT CLASS="FILENAME">/global</TT>目录对应。</P><P> <CODE CLASS="FUNCTION">pg_relation_filepath()</CODE>函数用于显示任何关系的完整路径（相对于<TT CLASS="VARNAME">PGDATA</TT>），
与记住上述规则相比，该函数是非常有用的。但是请记住，
这个函数只给了关系主分支文件的第一部分的名称&mdash;你可能还需要在其后添加
数字和/或<TT CLASS="LITERAL">_fsm</TT> or <TT CLASS="LITERAL">_vm</TT>后缀来找到与该关系相关的所有文件。</P><P> 临时文件（对于一些操作，如对超过内存大小的数据进行排序）会被创建，其通常
在<TT CLASS="VARNAME">PGDATA</TT><TT CLASS="FILENAME">/base/pgsql_tmp</TT>目录下，如果表空间不是<TT CLASS="LITERAL">pg_default</TT>，
则在表空间目录的<TT CLASS="FILENAME">pgsql_tmp</TT>子目录下。
临时文件名表示为<TT CLASS="FILENAME">pgsql_tmp<TT CLASS="REPLACEABLE"><I>PPP</I></TT>.<TT CLASS="REPLACEABLE"><I>NNN</I></TT></TT>，
这里<TT CLASS="REPLACEABLE"><I>PPP</I></TT>是其后端进程的PID，<TT CLASS="REPLACEABLE"><I>NNN</I></TT>用以区分后端进程的不同临时文件。</P></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/storage.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="storage-toast.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">数据库物理存储</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/storage.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">TOAST</TD></TR></TABLE></DIV></BODY></HTML>
