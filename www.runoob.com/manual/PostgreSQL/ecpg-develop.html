<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>内部</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="ECPG - 在C中嵌入SQL" HREF="http://school.yunwei.edu/manual/PostgreSQL/ecpg.html"><LINK REL="PREVIOUS" TITLE="Informix兼容模式" HREF="ecpg-informix-compat.html"><LINK REL="NEXT" TITLE="信息模式" HREF="http://school.yunwei.edu/manual/PostgreSQL/information-schema.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/ecpg.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="Informix兼容模式" HREF="ecpg-informix-compat.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/ecpg.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#31456; 33. <SPAN CLASS="APPLICATION">ECPG</SPAN> - 在C中嵌入<ACRONYM CLASS="ACRONYM">SQL</ACRONYM></TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="信息模式" HREF="http://school.yunwei.edu/manual/PostgreSQL/information-schema.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="ECPG-DEVELOP">33.16. 内部</A></H1><P> 这一节解释<SPAN CLASS="APPLICATION">ECPG</SPAN>在内部是如何运转的。
这些信息有时候可以帮助用户理解如何使用<SPAN CLASS="APPLICATION">ECPG</SPAN>。</P><P> <TT CLASS="COMMAND">ecpg</TT>写到输出里的头四行是固定的行。两行是注释，
另外两行是与库接口的必要行。
然后预处理器读取文件并且写输出流。
通常它只是把所有东西都回显到输出中去。</P><P> 如果它看到一个<TT CLASS="COMMAND">EXEC SQL</TT>语句，
它就变换并且修改它。命令以<TT CLASS="COMMAND">EXEC SQL</TT>开头，以<TT CLASS="COMMAND">;</TT>结尾。
所有在中间的东西都被当
作一个<ACRONYM CLASS="ACRONYM">SQL</ACRONYM>语句并且进行变量代换的解析。</P><P> 如果一个符号以一个冒号（<TT CLASS="LITERAL">:</TT>）开头，则发生变量代换。
在<TT CLASS="LITERAL">EXEC SQL DECLARE</TT>段里预先声明的变量中找出该名字的变量。</P><P> 库里面最重要的函数是<CODE CLASS="FUNCTION">ECPGdo</CODE>，它负责执行大多数命令。
它接受变量的参数个数。
这些参数的个数可能很容易达到50个或者更多，
我们希望在任何平台上这都不是问题。</P><P>
参数是：
<P></P></P><DIV CLASS="VARIABLELIST"><DL><DT>行号</DT><DD><P>
这是原始行的行号；只是在错误信息中使用。
</P></DD><DT>字符串</DT><DD><P> 这是要发出的<ACRONYM CLASS="ACRONYM">SQL</ACRONYM>命令。
它被输入变量修改，也就是说，在编译时未知的，
但是需要输入到命令中的变量。
此处变量应该包含字符串<TT CLASS="LITERAL">?</TT>。&#13;</P></DD><DT>输入变量</DT><DD><P> 每个输入变量都导致十个参数的生成。（见下文） </P></DD><DT><TT CLASS="PARAMETER">ECPGt_EOIT</TT></DT><DD><P> 一个<TT CLASS="TYPE">enum</TT>告诉没有更多输入变量了。 </P></DD><DT>输出变量</DT><DD><P> 每个输出变量导致十个参数的创建。（见下文）
这些变量被这些函数填充。 </P></DD><DT><TT CLASS="PARAMETER">ECPGt_EORT</TT></DT><DD><P> 一个指出没有更多变量的<TT CLASS="TYPE">enum</TT>。 </P></DD></DL></DIV><P>
</P><P>
对于每个属于<ACRONYM CLASS="ACRONYM">SQL</ACRONYM>命令一部分的变量，
函数可以得到十个参数：
<P></P></P><OL TYPE="1"><LI><P>
作为特殊符号的类型。
</P></LI><LI><P> 一个指向其数值的指针，或者一个指向指针的指针。</P></LI><LI><P> 如果变量大小是<TT CLASS="TYPE">char</TT>或者<TT CLASS="TYPE">varchar</TT>。</P></LI><LI><P> 数组中元素的个数（用于抓取数组）。</P></LI><LI><P> 指向数组中下一个元素的偏移量（用于抓取数组）。</P></LI><LI><P> 作为一种特殊符号的指示器变量的类型。</P></LI><LI><P> 一个指向指示器变量的指针。</P></LI><LI><P> 0
</P></LI><LI><P> 指示器数组中的元素个数（用于抓取数组）。</P></LI><LI><P> 指向指示器数组的下一个元素的偏移量（用于抓取数组）。</P></LI></OL><P>
</P><P>
请注意，不是所有SQL命令都这么被对待。
比如，一个像下面这样的打开游标的语句。
</P><PRE CLASS="PROGRAMLISTING">EXEC SQL OPEN <TT
CLASS="REPLACEABLE"
><I
>cursor</I
></TT
>;</PRE><P>
不会被拷贝到输出中。
而是在<TT CLASS="COMMAND">OPEN</TT>命令的位置使用游标的<TT CLASS="COMMAND">DECLARE</TT>命令， 因为它同样也打开游标。
</P><P>
下面是一个完整的例子，描述了文件<TT CLASS="FILENAME">foo.pgc</TT> 的预处理后的输出（细节可能随着每个不同的预处理器版本而变化）：
</P><PRE CLASS="PROGRAMLISTING">EXEC SQL BEGIN DECLARE SECTION;
int index;
int result;
EXEC SQL END DECLARE SECTION;
...
EXEC SQL SELECT res INTO :result FROM mytable WHERE index = :index;</PRE><P>
被翻译成：
</P><PRE CLASS="PROGRAMLISTING">&#13;/* 通过ecpg (2.6.0)处理，通过预处理器添加2个include文件*/

#include &#60;ecpgtype.h&#62;;
#include &#60;ecpglib.h&#62;;

/* exec sql开始声明段 */

#line 1 "foo.pgc"

 int index;
 int result;
 
/* exec sql结束声明段 */
...
ECPGdo(__LINE__, NULL, "SELECT res FROM mytable WHERE index = ?     ",
        ECPGt_int,&#38;(index),1L,1L,sizeof(int),
        ECPGt_NO_INDICATOR, NULL , 0L, 0L, 0L, ECPGt_EOIT,
        ECPGt_int,&#38;(result),1L,1L,sizeof(int),
        ECPGt_NO_INDICATOR, NULL , 0L, 0L, 0L, ECPGt_EORT);
#line 147 "foo.pgc"</PRE><P>
(这里的凹进是为了增强可读性加的，可不是预处理器能干的事情。)
</P></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="ecpg-informix-compat.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/information-schema.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><SPAN CLASS="PRODUCTNAME">Informix</SPAN>兼容模式</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/ecpg.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">信息模式</TD></TR></TABLE></DIV></BODY></HTML>
