<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><TITLE>pg_stat_statements</TITLE><META NAME="GENERATOR" CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK REV="MADE" HREF="mailto:pgsql-docs@postgresql.org"><LINK REL="HOME" TITLE="PostgreSQL 9.3.1 中文手册" HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html"><LINK REL="UP" TITLE="额外提供的模块" HREF="http://school.yunwei.edu/manual/PostgreSQL/contrib.html"><LINK REL="PREVIOUS" TITLE="pgrowlocks" HREF="pgrowlocks.html"><LINK REL="NEXT" TITLE="pgstattuple" HREF="pgstattuple.html"><LINK REL="STYLESHEET" TYPE="text/css" HREF="http://school.yunwei.edu/manual/PostgreSQL/stylesheet.css"><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><META NAME="creation" CONTENT="2015-07-11T14:00:17"></HEAD><BODY CLASS="SECT1">
<div style="text-align:right">
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/issues/new" target="_blank" title="在Github上报告问题（请注明问题内容及所在章节）">问题报告</a>
<a style="margin : 0px 0px 0px 10px;" href="https://github.com/postgres-cn/pgdoc-cn/edit/master/postgresql/doc/src/sgml/pgstatstatements.sgml" target="_blank" title="直接在Github上纠错本页面">纠错本页面</a>
</div>
<DIV CLASS="NAVHEADER"><TABLE SUMMARY="Header navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TH COLSPAN="5" ALIGN="center" VALIGN="bottom"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html">PostgreSQL 9.3.1 中文手册</A></TH></TR><TR><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A TITLE="pgrowlocks" HREF="pgrowlocks.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="10%" ALIGN="left" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/contrib.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="60%" ALIGN="center" VALIGN="bottom">&#38468;&#24405; F. 额外提供的模块</TD><TD WIDTH="20%" ALIGN="right" VALIGN="top"><A TITLE="pgstattuple" HREF="pgstattuple.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR></TABLE><HR ALIGN="LEFT" WIDTH="100%"></DIV><DIV CLASS="SECT1"><H1 CLASS="SECT1"><A NAME="PGSTATSTATEMENTS">F.28. pg_stat_statements</A></H1><P><TT CLASS="FILENAME">pg_stat_statements</TT>模块提供一种跟踪执行统计服务器执行的所有SQL语句的手段。</P><P>该模块必须通过在<TT CLASS="FILENAME">postgresql.conf</TT>中添加<TT CLASS="LITERAL">pg_stat_statements</TT>
到<A HREF="runtime-config-resource.html#GUC-SHARED-PRELOAD-LIBRARIES">shared_preload_libraries</A>来加载，因为它需要额外的共享内存。
这意味着添加或删除这个模块都需要重启服务器。</P><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="AEN148920">F.28.1. <TT CLASS="STRUCTNAME">pg_stat_statements</TT> 视图</A></H2><P>该模块聚集的统计通过一个名为<TT CLASS="STRUCTNAME">pg_stat_statements</TT>的系统视图使其可用。
这个模块为每个不同的查询、数据库ID和用户ID（取决于该模块可以追踪的不同语句的最大值）
包含一行。视图的字段显示在<A HREF="pgstatstatements.html#PGSTATSTATEMENTS-COLUMNS">&#34920; F-20</A>中。</P><DIV CLASS="TABLE"><A NAME="PGSTATSTATEMENTS-COLUMNS"></A><P><B>&#34920; F-20. <TT CLASS="STRUCTNAME">pg_stat_statements</TT> 字段</B></P><TABLE BORDER="1" CLASS="CALSTABLE"><COL><COL><COL><COL><THEAD><TR><TH>名字</TH><TH>类型</TH><TH>参考</TH><TH>描述</TH></TR></THEAD><TBODY><TR><TD><TT CLASS="STRUCTFIELD">userid</TT></TD><TD><TT CLASS="TYPE">oid</TT></TD><TD><TT CLASS="LITERAL"><A HREF="catalog-pg-authid.html"><TT CLASS="STRUCTNAME">pg_authid</TT></A>.oid</TT></TD><TD>执行该语句的用户的OID</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">dbid</TT></TD><TD><TT CLASS="TYPE">oid</TT></TD><TD><TT CLASS="LITERAL"><A HREF="catalog-pg-database.html"><TT CLASS="STRUCTNAME">pg_database</TT></A>.oid</TT></TD><TD>执行该语句的数据库的OID</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">query</TT></TD><TD><TT CLASS="TYPE">text</TT></TD><TD>&nbsp;</TD><TD>有代表性的语句的文本 (多达 <A HREF="runtime-config-statistics.html#GUC-TRACK-ACTIVITY-QUERY-SIZE">track_activity_query_size</A> 字节)</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">calls</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>执行的次数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">total_time</TT></TD><TD><TT CLASS="TYPE">double precision</TT></TD><TD>&nbsp;</TD><TD>该语句花费的总时间，以毫秒计</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">rows</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句恢复或影响的行的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">shared_blks_hit</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句命中的共享块缓存的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">shared_blks_read</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句读取的共享块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">shared_blks_dirtied</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句弄脏的共享块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">shared_blks_written</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句写入的共享块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">local_blks_hit</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句命中的本地块缓存的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">local_blks_read</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句读取的本地块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">local_blks_dirtied</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句弄脏的本地块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">local_blks_written</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句写入的本地块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">temp_blks_read</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句读取的临时块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">temp_blks_written</TT></TD><TD><TT CLASS="TYPE">bigint</TT></TD><TD>&nbsp;</TD><TD>该语句写入的临时块的总数</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">blk_read_time</TT></TD><TD><TT CLASS="TYPE">double precision</TT></TD><TD>&nbsp;</TD><TD>
该语句读取块花费的总时间，以毫秒计
（如果启用了<A HREF="runtime-config-statistics.html#GUC-TRACK-IO-TIMING">track_io_timing</A>，否则为0）
</TD></TR><TR><TD><TT CLASS="STRUCTFIELD">blk_write_time</TT></TD><TD><TT CLASS="TYPE">double precision</TT></TD><TD>&nbsp;</TD><TD>
该语句写入块花费的总时间，以毫秒计
（如果启用了<A HREF="runtime-config-statistics.html#GUC-TRACK-IO-TIMING">track_io_timing</A>，否则为0）
</TD></TR></TBODY></TABLE></DIV><P>这个视图和函数<CODE CLASS="FUNCTION">pg_stat_statements_reset</CODE>，只有在通过安装
<TT CLASS="LITERAL">pg_stat_statements</TT>扩展特别安装到的数据库中可用。
不过，当<TT CLASS="FILENAME">pg_stat_statements</TT>模块加载到服务器中时，
统计跟踪该服务器中的所有数据库，不管该视图是否存在。</P><P>为了安全起见，不允许非超级用户查看其它用户执行的查询的文本。不过，
如果视图已经安装到他们的数据库中，那么他们可以看到统计。</P><P>可计划的查询（也就是，<TT CLASS="COMMAND">SELECT</TT>, <TT CLASS="COMMAND">INSERT</TT>,
<TT CLASS="COMMAND">UPDATE</TT>, 和 <TT CLASS="COMMAND">DELETE</TT>）组合成为一个<TT CLASS="STRUCTNAME">pg_stat_statements</TT>，
当它们根据一个内部哈希计算有相同的查询结构时。典型的，如果两个查询语义上相等，
除了查询中字面常量的值之外，我们认为这两个查询相同。工具命令（也就是，所有其他命令）
是直接基于它们的文本查询字符串比较的。</P><P>当一个常量的值为了匹配其他查询而忽略时，该常量在<TT CLASS="STRUCTNAME">pg_stat_statements</TT>
的显示中被<TT CLASS="LITERAL">?</TT>替代。查询文本的剩余部分是第一个查询特定散列值与
<TT CLASS="STRUCTNAME">pg_stat_statements</TT>相关条目。</P><P>在一些情况下，带有明显不同文本的查询可能合并到一个<TT CLASS="STRUCTNAME">pg_stat_statements</TT>。
通常这只在语义相等的查询上发生，但是有很小的可能哈希冲突导致不相关的查询被合并到一个条目。
（不过，这对于属于不同用户或数据库的查询来说是不会发生的。）</P><P>因为哈希值是基于分析查询的表示法之后来计算的，相反的也是可能的：
带有相同文本的查询可能表现为单独的条目，如果它们因为一个因素的结果有不同的含义，
比如不同的<TT CLASS="VARNAME">search_path</TT>设置。</P></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="AEN149091">F.28.2. 函数</A></H2><P></P><DIV CLASS="VARIABLELIST"><DL><DT><CODE CLASS="FUNCTION">pg_stat_statements_reset() returns void</CODE></DT><DD><P><CODE CLASS="FUNCTION">pg_stat_statements_reset</CODE>抛弃所有<TT CLASS="FILENAME">pg_stat_statements</TT>
到目前为止收集的统计。缺省的，这个函数只能被超级用户执行。</P></DD></DL></DIV></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="AEN149103">F.28.3. 配置参数</A></H2><P></P><DIV CLASS="VARIABLELIST"><DL><DT><TT CLASS="VARNAME">pg_stat_statements.max</TT> (<TT CLASS="TYPE">integer</TT>)</DT><DD><P><TT CLASS="VARNAME">pg_stat_statements.max</TT>是该模块追踪语句的最大值
（也就是，<TT CLASS="STRUCTNAME">pg_stat_statements</TT>视图中的最大行数）。
如果观察了比这更多的不同的语句，则会抛弃执行最少的语句的信息。
缺省值是1000。这个参数只能在服务器启动时设置。</P></DD><DT><TT CLASS="VARNAME">pg_stat_statements.track</TT> (<TT CLASS="TYPE">enum</TT>)</DT><DD><P><TT CLASS="VARNAME">pg_stat_statements.track</TT>控制哪个语句可以被该模块计数。
声明<TT CLASS="LITERAL">top</TT>来跟踪顶级的语句（直接通过客户端发出的语句）。<TT CLASS="LITERAL">all</TT>
也跟踪嵌套的语句（比如包含在函数中的语句），或<TT CLASS="LITERAL">none</TT>禁用语句状态收集。
缺省值是<TT CLASS="LITERAL">top</TT>。只有超级用户可以更改这个设置。</P></DD><DT><TT CLASS="VARNAME">pg_stat_statements.track_utility</TT> (<TT CLASS="TYPE">boolean</TT>)</DT><DD><P><TT CLASS="VARNAME">pg_stat_statements.track_utility</TT>控制该模块是否追踪工具命令。
工具命令是除了<TT CLASS="COMMAND">SELECT</TT>, <TT CLASS="COMMAND">INSERT</TT>, <TT CLASS="COMMAND">UPDATE</TT> 和
<TT CLASS="COMMAND">DELETE</TT>的所有命令。缺省值是<TT CLASS="LITERAL">on</TT>。只有超级用户可以更改这个设置。</P></DD><DT><TT CLASS="VARNAME">pg_stat_statements.save</TT> (<TT CLASS="TYPE">boolean</TT>)</DT><DD><P><TT CLASS="VARNAME">pg_stat_statements.save</TT>指定在服务器关闭时是否保存语句状态。
如果是<TT CLASS="LITERAL">off</TT>，那么在服务器关闭时不保存状态，在服务器启动时也不重新加载。
缺省值是<TT CLASS="LITERAL">on</TT>。这个参数只可以在<TT CLASS="FILENAME">postgresql.conf</TT>
文件中或者服务器命令行中设置。</P></DD></DL></DIV><P>该模块需要额外的共享内存总计大约为
<TT CLASS="VARNAME">pg_stat_statements.max</TT> <TT CLASS="LITERAL">*</TT>
<A HREF="runtime-config-statistics.html#GUC-TRACK-ACTIVITY-QUERY-SIZE">track_activity_query_size</A>字节。请注意，
这个内存在该模块加载时被消耗，即使<TT CLASS="VARNAME">pg_stat_statements.track</TT>
设置为<TT CLASS="LITERAL">none</TT>。</P><P>
这些参数必须在<TT CLASS="FILENAME">postgresql.conf</TT>中设置。典型的用法是：
</P><PRE CLASS="PROGRAMLISTING"># postgresql.conf
shared_preload_libraries = 'pg_stat_statements'

pg_stat_statements.max = 10000
pg_stat_statements.track = all</PRE><P>
</P></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="AEN149156">F.28.4. 示例输出</A></H2><PRE CLASS="SCREEN">bench=# SELECT pg_stat_statements_reset();

$ pgbench -i bench
$ pgbench -c10 -t300 bench

bench=# \x
bench=# SELECT query, calls, total_time, rows, 100.0 * shared_blks_hit /
               nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent
          FROM pg_stat_statements ORDER BY total_time DESC LIMIT 5;
-[ RECORD 1 ]---------------------------------------------------------------------
query       | UPDATE pgbench_branches SET bbalance = bbalance + ? WHERE bid = ?;
calls       | 3000
total_time  | 9609.00100000002
rows        | 2836
hit_percent | 99.9778970000200936
-[ RECORD 2 ]---------------------------------------------------------------------
query       | UPDATE pgbench_tellers SET tbalance = tbalance + ? WHERE tid = ?;
calls       | 3000
total_time  | 8015.156
rows        | 2990
hit_percent | 99.9731126579631345
-[ RECORD 3 ]---------------------------------------------------------------------
query       | copy pgbench_accounts from stdin
calls       | 1
total_time  | 310.624
rows        | 100000
hit_percent | 0.30395136778115501520
-[ RECORD 4 ]---------------------------------------------------------------------
query       | UPDATE pgbench_accounts SET abalance = abalance + ? WHERE aid = ?;
calls       | 3000
total_time  | 271.741999999997
rows        | 3000
hit_percent | 93.7968855088209426
-[ RECORD 5 ]---------------------------------------------------------------------
query       | alter table pgbench_accounts add primary key (aid)
calls       | 1
total_time  | 81.42
rows        | 0
hit_percent | 34.4947735191637631</PRE></DIV><DIV CLASS="SECT2"><H2 CLASS="SECT2"><A NAME="AEN149159">F.28.5. 作者</A></H2><P>Takahiro Itagaki <CODE CLASS="EMAIL">&#60;<A HREF="mailto:itagaki.takahiro@oss.ntt.co.jp">itagaki.takahiro@oss.ntt.co.jp</A>&#62;</CODE>。
Peter Geoghegan <CODE CLASS="EMAIL">&#60;<A HREF="mailto:peter@2ndquadrant.com">peter@2ndquadrant.com</A>&#62;</CODE>添加了查询正常化。</P></DIV></DIV><DIV CLASS="NAVFOOTER"><HR ALIGN="LEFT" WIDTH="100%"><TABLE SUMMARY="Footer navigation table" WIDTH="100%" BORDER="0" CELLPADDING="0" CELLSPACING="0"><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top"><A HREF="pgrowlocks.html" ACCESSKEY="P">&#19978;&#19968;&#39029;</A></TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/index.html" ACCESSKEY="H">&#36215;&#22987;&#39029;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top"><A HREF="pgstattuple.html" ACCESSKEY="N">&#19979;&#19968;&#39029;</A></TD></TR><TR><TD WIDTH="33%" ALIGN="left" VALIGN="top">pgrowlocks</TD><TD WIDTH="34%" ALIGN="center" VALIGN="top"><A HREF="http://school.yunwei.edu/manual/PostgreSQL/contrib.html" ACCESSKEY="U">&#19978;&#19968;&#32423;</A></TD><TD WIDTH="33%" ALIGN="right" VALIGN="top">pgstattuple</TD></TR></TABLE></DIV></BODY></HTML>
